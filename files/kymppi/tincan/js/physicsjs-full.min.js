(function(n,t){typeof exports=="object"?module.exports=t.call(n):typeof define=="function"&&define.amd?define(function(){return t.call(n)}):n.Physics=t.call(n)})(typeof window!="undefined"?window:this,function(){"use strict";var t=this,i=t.document,n=function n(){return n.world.apply(n,arguments)},r,u;return n.util={},function(){n.aabb=function(n,t,i,r){var u={x:0,y:0,hw:0,hh:0};return n===undefined?u:(n&&n.x!==undefined&&(i=t.x,r=t.y,t=n.y,n=n.x),r===undefined&&n!==undefined&&t!==undefined)?(u.hw=n*.5,u.hh=t*.5,i&&i.x!==undefined&&(u.x=i.x,u.y=i.y),u):(u.hw=Math.abs(i-n)*.5,u.hh=Math.abs(r-t)*.5,u.x=(i+n)*.5,u.y=(r+t)*.5,u)};n.aabb.contains=function(n,t){return t.x>n.x-n.hw&&t.x<n.x+n.hw&&t.y>n.y-n.hh&&t.y<n.y+n.hh};n.aabb.clone=function(n){return{x:n.x,y:n.y,hw:n.hw,hh:n.hh}};n.aabb.union=function(n,t,i){var r=i===!0?n:{},u=Math.max(n.x+n.hw,t.x+t.hw),f=Math.max(n.y+n.hh,t.y+t.hh),e=Math.min(n.x-n.hw,t.x-t.hw),o=Math.min(n.y-n.hh,t.y-t.hh);return r.hw=Math.abs(u-e)*.5,r.hh=Math.abs(f-o)*.5,r.x=(u+e)*.5,r.y=(f+o)*.5,r};n.aabb.overlap=function(n,t){var u=n.x-n.hw,f=t.x-t.hw,i=n.x+n.hw,r=t.x+t.hw;return f<=i&&i<=r||u<=r&&r<=i?(u=n.y-n.hh,f=t.y-t.hh,i=n.y+n.hh,r=t.y+t.hh,f<=i&&i<=r||u<=r&&r<=i):!1}}(),function(){var i=.0001,r=100,t=function(n,t,i){var r=t.normSq()-t.dot(n),u=t.dot(n)-n.normSq();return r<0?i.clone(t).negate():u>0?i.clone(n).negate():(i.clone(t).vsub(n),i.perp(n.cross(i)>0))},u=function(t){var h=t.length,i=t[h-2],u=t[h-3],r=n.scratchpad(),o=r.vector().clone(i.pt),f=r.vector().clone(u.pt).vsub(o),e,s;return f.equals(n.vector.zero)?r.done({a:i.a,b:i.b}):(e=-f.dot(o)/f.normSq(),s=1-e,s<=0)?r.done({a:u.a,b:u.b}):e<=0?r.done({a:i.a,b:i.b}):r.done({a:o.clone(i.a).mult(s).vadd(f.clone(u.a).mult(e)).values(),b:o.clone(i.b).mult(s).vadd(f.clone(u.b).mult(e)).values()})},f=function(f,e,o,s){var d=!1,g=!1,nt=!1,h=[],tt=1,v=n.scratchpad(),c=v.vector().clone(e||n.vector.axis[0]),a=v.vector(),w=v.vector(),it=v.vector(),rt=v.vector(),y,p,b,l,k=0;for(l=f(c),tt=h.push(l),a.clone(l.pt),c.negate();++k;){if(a.swap(w),l=f(c),tt=h.push(l),a.clone(l.pt),s&&s(h),a.equals(n.vector.zero)){d=!0;break}if(!g&&a.dot(c)<=0){if(o)break;g=!0}if(tt===2)c=t(a,w,c);else if(g){if(c.normalize(),l=w.dot(c),Math.abs(l-a.dot(c))<i){nt=-l;break}w.normSq()<it.clone(h[0].pt).normSq()?h.shift():h.splice(1,1);c=t(it.clone(h[1].pt),rt.clone(h[0].pt),c)}else if(y=y||v.vector(),p=p||v.vector(),y.clone(w).vsub(a),p.clone(h[0].pt).vsub(a),b=y.cross(p)>0,b^a.cross(y)>0)h.shift(),y.perp(!b),c.swap(y);else if(b^p.cross(a)>0)h.splice(1,1),p.perp(b),c.swap(y);else{d=!0;break}if(k>r)return v.done(),{simplex:h,iterations:k,distance:0,maxIterationsReached:!0}}return v.done(),l={overlap:d,simplex:h,iterations:k},nt!==!1&&(l.distance=nt,l.closest=u(h)),l};n.gjk=f}(),function(){n.statistics={pushRunningAvg:function(n,t,i,r){var u=n-i;return i+=u/t,r+=u*(n-i),[i,r]},pushRunningVectorAvg:function(n,t,i,r){var e=1/t,u=n.get(0)-i.get(0),f=n.get(1)-i.get(1);i.add(u*e,f*e);r&&(u*=n.get(0)-i.get(0),f*=n.get(1)-i.get(1),r.add(u,f))}}}(),function(){var t=function t(i,r,u){if(!(this instanceof t))return new t(i,r);if(this.v=new n.vector,this.o=new n.vector,i instanceof t){this.clone(i);return}i&&this.setTranslation(i);this.setRotation(r||0,u)};t.prototype.setTranslation=function(n){return this.v.clone(n),this};t.prototype.setRotation=function(n,t){return this.cosA=Math.cos(n),this.sinA=Math.sin(n),t?this.o.clone(t):this.o.zero(),this};t.prototype.clone=function(n){return n?(this.setTranslation(n.v),this.cosA=n.cosA,this.sinA=n.sinA,this.o.clone(n.o),this):new t(this)};n.transform=t}(),function(t){var u=Math.sqrt,e=Math.min,o=Math.max,h=Math.acos,f=Math.atan2,r=Math.PI*2,s=!!t.Float64Array,i=function i(n,t){if(!(this instanceof i))return new i(n,t);this._=s?new Float64Array(5):[];n&&(n.x!==undefined||n._&&n._.length)?this.clone(n):(this.recalc=!0,this.set(n,t))};Object.defineProperties(i.prototype,{x:{get:function(){return+this._[0]},set:function(n){n=+n||0;this.recalc=n===this._[0];this._[0]=n}},y:{get:function(){return+this._[1]},set:function(n){n=+n||0;this.recalc=n===this._[1];this._[1]=n}}});i.prototype.set=function(n,t){return this.recalc=!0,this._[0]=+n||0,this._[1]=+t||0,this};i.prototype.get=function(n){return this._[n]};i.prototype.vadd=function(n){return this.recalc=!0,this._[0]+=n._[0],this._[1]+=n._[1],this};i.prototype.vsub=function(n){return this.recalc=!0,this._[0]-=n._[0],this._[1]-=n._[1],this};i.prototype.add=function(n,t){return this.recalc=!0,this._[0]+=+n||0,this._[1]+=+t||0,this};i.prototype.sub=function(n,t){return this.recalc=!0,this._[0]-=n,this._[1]-=t===undefined?0:t,this};i.prototype.mult=function(n){return this.recalc||(this._[4]*=n*n,this._[3]*=n),this._[0]*=n,this._[1]*=n,this};i.prototype.dot=function(n){return this._[0]*n._[0]+this._[1]*n._[1]};i.prototype.cross=function(n){return-this._[0]*n._[1]+this._[1]*n._[0]};i.prototype.proj=function(n){return this.dot(n)/n.norm()};i.prototype.vproj=function(n){var t=this.dot(n)/n.normSq();return this.clone(n).mult(t)};i.prototype.angle=function(n){var t;if(this.equals(i.zero))return n?n.angle():NaN;for(t=n&&!n.equals(i.zero)?f(this._[1]*n._[0]-this._[0]*n._[1],this._[0]*n._[0]+this._[1]*n._[1]):f(this._[1],this._[0]);t>Math.PI;)t-=r;while(t<-Math.PI)t+=r;return t};i.prototype.angle2=function(n,t){for(var u=n._[0]-this._[0],e=n._[1]-this._[1],o=t._[0]-this._[0],s=t._[1]-this._[1],i=f(e*o-u*s,u*o+e*s);i>Math.PI;)i-=r;while(i<-Math.PI)i+=r;return i};i.prototype.norm=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=u(this._[4])),this._[3]};i.prototype.normSq=function(){return this.recalc&&(this.recalc=!1,this._[4]=this._[0]*this._[0]+this._[1]*this._[1],this._[3]=u(this._[4])),this._[4]};i.prototype.dist=function(n){var t,i;return u((t=n._[0]-this._[0])*t+(i=n._[1]-this._[1])*i)};i.prototype.distSq=function(n){var t,i;return(t=n._[0]-this._[0])*t+(i=n._[1]-this._[1])*i};i.prototype.perp=function(n){var t=this._[0];return n?(this._[0]=this._[1],this._[1]=-t):(this._[0]=-this._[1],this._[1]=t),this};i.prototype.normalize=function(){var n=this.norm();return n===0?this:(n=1/n,this._[0]*=n,this._[1]*=n,this._[3]=1,this._[4]=1,this)};i.prototype.transform=function(n){var t=n.sinA,i=n.cosA,r=n.o._[0],u=n.o._[1];return this._[0]-=r,this._[1]-=u,this.set(this._[0]*i-this._[1]*t+r+n.v._[0],this._[0]*t+this._[1]*i+u+n.v._[1])};i.prototype.transformInv=function(n){var t=n.sinA,i=n.cosA,r=n.o._[0],u=n.o._[1];return this._[0]-=r+n.v._[0],this._[1]-=u+n.v._[1],this.set(this._[0]*i+this._[1]*t+r,-this._[0]*t+this._[1]*i+u)};i.prototype.rotate=function(n,t){var i,r,u=0,f=0;return typeof n=="number"?(i=Math.sin(n),r=Math.cos(n),t&&(u=t.x,f=t.y)):(i=n.sinA,r=n.cosA,u=n.o._[0],f=n.o._[1]),this._[0]-=u,this._[1]-=f,this.set(this._[0]*r-this._[1]*i+u,this._[0]*i+this._[1]*r+f)};i.prototype.rotateInv=function(n){return this.set((this._[0]-n.o._[0])*n.cosA+(this._[1]-n.o._[1])*n.sinA+n.o._[0],-(this._[0]-n.o._[0])*n.sinA+(this._[1]-n.o._[1])*n.cosA+n.o._[1])};i.prototype.translate=function(n){return this.vadd(n.v)};i.prototype.translateInv=function(n){return this.vsub(n.v)};i.prototype.clone=function(n){return n?n._?(this.recalc=n.recalc,n.recalc||(this._[3]=n._[3],this._[4]=n._[4]),this._[0]=n._[0],this._[1]=n._[1],this):this.set(n.x,n.y):new i(this)};i.prototype.swap=function(n){var t=this._;return this._=n._,n._=t,t=this.recalc,this.recalc=n.recalc,n.recalc=t,this};i.prototype.values=function(){return{x:this._[0],y:this._[1]}};i.prototype.zero=function(){return this._[3]=0,this._[4]=0,this._[0]=0,this._[1]=0,this};i.prototype.negate=function(n){return n!==undefined?(this._[n]=-this._[n],this):(this._[0]=-this._[0],this._[1]=-this._[1],this)};i.prototype.clamp=function(n,t){return this._[0]=e(o(this._[0],n.x),t.x),this._[1]=e(o(this._[1],n.y),t.y),this.recalc=!0,this};i.prototype.toString=function(){return"("+this._[0]+", "+this._[1]+")"};i.prototype.equals=function(n){return this._[0]===n._[0]&&this._[1]===n._[1]&&this._[2]===n._[2]};i.axis=[new i(1,0),new i(0,1)];i.zero=new i(0,0);n.vector=i}(this),function(t){var i=t.Physics;n.noConflict=function(){return t.Physics===n&&(t.Physics=i),n}}(this),r=n.util.decorator=function(t,i){var u={},r={},e=function(t,i){var r;for(var u in i)r=Object.getOwnPropertyDescriptor(i,u),r.get||r.set?Object.defineProperty(t,u,r):n.util.isFunction(r.value)&&(t[u]=r.value);return t},o=Object.getPrototypeOf,f,s,h;return typeof o!="function"&&(o=typeof"test".__proto__=="object"?function(n){return n.__proto__}:function(n){return n.constructor.prototype}),f=Object.create,typeof f!="function"&&(f=function(n){function t(){}return t.prototype=n,new t}),s=function(i,u){if(typeof i=="object"){r=e(r,i);r.type=t;return}i!=="type"&&n.util.isFunction(u)&&(r[i]=u)},s(i),h=function(n,i,s,h){var c,l=r;if(typeof i!="string")h=s,s=i;else{if(l=u[i],!l)throw'Error: "'+i+'" '+t+" not defined";l=l.prototype}if(typeof s=="function")c=u[n],c?c.prototype=e(c.prototype,s(o(c.prototype))):(c=u[n]=function(n){this.init&&this.init(n)},c.prototype=f(l),c.prototype=e(c.prototype,s(l,c.prototype))),c.prototype.type=t,c.prototype.name=n;else if(h=s||{},c=u[n],!c)throw'Error: "'+n+'" '+t+" not defined";if(h)return new c(h)},h.mixin=s,h},n.util.indexOf=function(n,t){for(var i=0,r=n.length;i<r;){if(r--,n[i]===t)return i;if(n[r]===t)return r;i++}return-1},n.util.clearArray=function(n){for(var t=n.length;t--;)n.pop();return n},n.util.throttle=function(n,t,i){var r,u=!1,f,e=function(){clearTimeout(r);u?(u=!1,r=setTimeout(e,t),n.apply(i,f)):r=!1};return i=i||null,function(){u=!0;f=arguments;r||e()}},u=function(t,i){return n.util.isPlainObject(i)?n.util.extend({},t,i,u):i!==undefined?i:t},n.util.options=function(t,i){var f={},r,e=[];return r=function(t,r){n.util.extend(i,t,r?u:null);for(var f=0,o=e.length;f<o;++f)e[f](i);return i},r.defaults=function(t,r){return n.util.extend(f,t,r?u:null),n.util.defaults(i,f,r?u:null),f},r.onChange=function(n){e.push(n)},i=i||r,r.defaults(t),r},n.util.pairHash=function(n,t){return(n=n|0,t=t|0,(n|0)==(t|0))?-1:((n|0)>(t|0)?n<<16|t&65535:t<<16|n&65535)|0},n.util.bind=Function.prototype.bind?function(n,t,i){return i=Array.prototype.slice.call(arguments,1),Function.prototype.bind.apply(n,i)}:function(n,t,i){return i=Array.prototype.slice.call(arguments,2),function(){return n.apply(t,i.concat(Array.prototype.slice.call(arguments)))}},n.util.find=function(n,t){for(var u=n.length,r,i=0;i<u;i++)if(r=n[i],t(r,i,n))return r},n.util.filter=function(n,t){for(var f=n.length,r,u=[],i=0;i<f;i++)r=n[i],t(r,i,n)&&u.push(r);return u},function(){
/*
 * @license
 * Modified version of:
 * Lo-Dash 2.4.1 (Custom Build) <http://lodash.com/>
 * Copyright 2012-2013 The Dojo Foundation <http://dojofoundation.org/>
 * Based on Underscore.js 1.5.2 <http://underscorejs.org/LICENSE>
 * Copyright 2009-2013 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
 * Available under MIT license <http://lodash.com/license>
 */
function c(t){n.util.clearArray(t);r.length<s&&r.push(t)}function l(n){var t=n.cache;t&&l(t);n.array=n.cache=n.criteria=n.object=n.number=n.string=n.value=null;u.length<s&&u.push(n)}function a(){return u.pop()||{array:null,cache:null,criteria:null,"false":!1,index:0,"null":!1,number:null,object:null,push:null,string:null,"true":!1,undefined:!1,value:null}}function nt(){return r.pop()||[]}function tt(t,i){var r=typeof i,u;return(t=t.cache,r==="boolean"||i==null)?t[i]?0:-1:(r!=="number"&&r!=="string"&&(r="object"),u=r==="number"?i:h+i,t=(t=t[r])&&t[u],r==="object"?t&&n.util.indexOf(t,i)>-1?0:-1:t?0:-1)}function it(n){var u=this.cache,t=typeof n,i,r;t==="boolean"||n==null?u[n]=!0:(t!=="number"&&t!=="string"&&(t="object"),i=t==="number"?n:h+n,r=u[t]||(u[t]={}),t==="object"?(r[i]||(r[i]=[])).push(n):r[i]=!0)}function rt(n){var u=-1,r=n.length,f=n[0],e=n[r/2|0],o=n[r-1],t,i;if(f&&typeof f=="object"&&e&&typeof e=="object"&&o&&typeof o=="object")return!1;for(t=a(),t["false"]=t["null"]=t["true"]=t.undefined=!1,i=a(),i.array=n,i.cache=t,i.push=it;++u<r;)i.push(n[u]);return i}function et(n,t){return n+Math.floor(Math.random()*(t-n+1))}function y(n){return typeof n=="function"}function ot(n){return typeof n=="function"&&p.test(n)}function w(n){var t,r,u;if(!(n&&i.call(n)===f)||(t=n.constructor,y(t)&&!(t instanceof t)))return!1;for(u in n)r=u;return typeof r=="undefined"||o.call(n,r)}function st(t,i,r){var f=-1,h=n.util.indexOf,v=t?t.length:0,a=[],e=!i&&v>=g&&h===n.util.indexOf,u=r||e?nt():a,y,o,s;for(e&&(y=rt(u),h=tt,u=y);++f<v;)o=t[f],s=r?r(o,f,t):o,(i?!f||u[u.length-1]!==s:h(u,s)<0)&&((r||e)&&u.push(s),a.push(o));return e?(c(u.array),l(u)):r&&c(u),a}var t={boolean:!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},k=function(n){return n},d="[object Array]",f="[object Object]",e=Object.keys,i=Object.prototype.toString,o=Object.prototype.hasOwnProperty,g=75,r=[],u=[],s=40,h=+new Date+"",ut=function(n){var i,r=n,u=[];if(!r||!t[typeof n])return u;for(i in r)o.call(r,i)&&u.push(i);return u},v=e?function(t){return n.util.isObject(t)?e(t):[]}:ut,ft=0,p,b;n.util.uniqueId=function(n){var t=++ft;return""+(n||"")+t};n.util.shuffle=function(n){for(var u=-1,f=n?n.length:0,t=Array(typeof f=="number"?f:0),o,r,i=0,e=n.length;i<e;i++)o=n[i],r=et(0,++u),t[u]=t[r],t[r]=o;return t};n.util.isObject=function(n){return!!(n&&t[typeof n])};n.util.isFunction=y;n.util.isArray=Array.isArray||function(n){return n&&typeof n=="object"&&typeof n.length=="number"&&i.call(n)===d||!1};p=RegExp("^"+String(i).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/toString| for [^\]]+/g,".*?")+"$");n.util.isPlainObject=Object.getPrototypeOf?function(n){if(!(n&&i.call(n)===f))return!1;var r=n.valueOf,t=ot(r)&&(t=Object.getPrototypeOf(r))&&Object.getPrototypeOf(t);return t?n===t||Object.getPrototypeOf(n)===t:w(n)}:w;n.util.uniq=function(n,t,i){return typeof t!="boolean"&&t!=null&&(i=t,t=!1),st(n,t,i)};b=function(n,i,r){var f,u=n,e=u;if(!u)return e;var o=arguments,l=0,h,s=typeof r=="number"?2:o.length;for(s>2&&typeof o[s-1]=="function"&&(h=o[--s]);++l<s;)if(u=o[l],u&&t[typeof u])for(var a=-1,c=t[typeof u]&&v(u),y=c?c.length:0;++a<y;)f=c[a],e[f]=h?h(e[f],u[f]):u[f];return e};n.util.extend=b;n.util.defaults=function(n,i,r){var f,u=n,e=u;if(!u)return e;for(var s=arguments,h=0,l=typeof r=="number"?2:s.length;++h<l;)if(u=s[h],u&&t[typeof u])for(var c=-1,o=t[typeof u]&&v(u),a=o?o.length:0;++c<a;)f=o[c],typeof e[f]=="undefined"&&(e[f]=u[f]);return e};n.util.sortedIndex=function(n,t,i){var r=0,f=n?n.length:r,u;for(i=i||k,t=i(t);r<f;)u=r+f>>>1,i(n[u])<t?r=u+1:f=u;return r}}(),n.scratchpad=function(){var f="Error: Scratchpad used after .done() called. (Could it be unintentionally scoped?)",e="Error: Scratchpad usage space out of bounds. (Did you forget to call .done()?)",o="Error: Too many scratchpads created. (Did you forget to call .done()?)",s="Error: Object is already registered.",r=[],h=0,i,t,u=0;return i=function(){if(this._active=!1,this._indexArr=[],++h>=t.maxScratches)throw o;},i.prototype={done:function(n){var t;for(this._active=!1,t=0;t<u;++t)this[t]=0;return r.push(this),n}},t=function t(n){if(n)return t.fn(n);var u=r.pop()||new i;return u._active=!0,u},t.maxScratches=100,t.maxIndex=20,t.fn=function(n){for(var f,t=[],u=0,e=n.length;u<e;u++)t.push(u);return t="a"+t.join(",a"),f=new Function("fn, scratches, Scratch","return function("+t+"){ var scratch = scratches.pop() || new Scratch( scratches );scratch._active = true;return scratch.done( fn(scratch, "+t+") );};"),f(n,r,i)},t.register=function(n,r,o){var l=i.prototype,h=u++,c="_"+n+"Stack",a=o&&o.useFactory;if(n in l)throw s;i.prototype[n]=function(){var i=this[c]||(this[c]=[]),n=this[h]|0;if(this[h]=n+1,!this._active)throw f;if(n>=t.maxIndex)throw e;return i[n]||(i[n]=a?r():new r)}},t.register("vector",n.vector),t.register("transform",n.transform),t}(),function(){function r(n){return n._priority_}var i=1,t;n.scratchpad.register("event",function(){return{}},{useFactory:!0});t=function t(){if(!(this instanceof t))return new t};t.prototype={on:function(t,u,f,e){var o,s,c,h;if(this._topics=this._topics||(this._topics={}),n.util.isObject(t)){for(h in t)this.on(h,t[h],u,f);return this}return o=this._topics[t]||(this._topics[t]=[]),s=u,n.util.isObject(f)?(u=n.util.bind(u,f),u._bindfn_=s,u._one_=s._one_,u._scope_=f):e===undefined&&(e=f),u._priority_=e===undefined?i:e,c=n.util.sortedIndex(o,u,r),o.splice(c,0,u),this},off:function(t,i,r){var u,e,o,f,s;if(!this._topics)return this;if(t===!0)return this._topics={},this;if(n.util.isObject(t)){for(o in t)this.off(o,t[o]);return this}if(u=this._topics[t],!u)return this;if(i===!0)return this._topics[t]=[],this;for(f=0,s=u.length;f<s;f++)if(e=u[f],(e._bindfn_===i||e===i)&&(!r||e._scope_===r)){u.splice(f,1);break}return this},emit:function(t,i){if(!this._topics)return this;var r=this._topics[t],u=r&&r.length,f,e,o=n.scratchpad();if(!u)return o.done(this);for(e=o.event(),e.topic=t,e.handler=f;u--;)f=r[u],f(i,e),f._one_&&r.splice(u,1);return o.done(this)},one:function(t,i,r){if(n.util.isObject(t)){for(var u in t)this.one(u,t[u],i,r);return this}i._one_=!0;this.on(t,i,r);return this}};n.util.pubsub=t}(),function(t){function f(){return r&&r.now?r.now()+r.timing.navigationStart:Date.now()}function e(){var n;(t.requestAnimationFrame(e),i)&&(n=f(),n)&&u.emit("tick",n)}function o(){return i=!0,this}function s(){return i=!1,this}function h(n){u.on("tick",n);return this}function c(n){return u.off("tick",n),this}function l(){return!!i}var i=!0,u=n.util.pubsub(),r=t.performance;t.requestAnimationFrame?e():i=!1;n.util.ticker={now:f,start:o,stop:s,on:h,off:c,isActive:l}}(this),function(){var e=function(){return!0},t=n.util.indexOf,o=function(n,t){return function(i){return n(i[t])}},r=function(i,r){return function(u){u=r?u[r]:u;var e=0,f;if(n.util.isArray(u)){if(n.util.isArray(i)){if(f=u.length,f!==i.length)return!1;while(e<f){if(f--,t(i,u[e])===-1||t(i,u[f])===-1)return!1;e++}return!0}return t(u,i)>-1}return u===i}},s=function(n,t){var i=r(n,t);return function(n){return!i(n)}},u=function(i,r){return function(u){u=r?u[r]:u;var e=0,f;if(n.util.isArray(u)){for(f=u.length;e<f;){if(f--,t(i,u[e])>-1||t(i,u[f])>-1)return!0;e++}return!1}return t(i,u)>-1}},h=function(n,t){var i=u(n,t);return function(n){return!i(n)}},c=function(t){return t=new n.vector(t),function(i){var r=i.aabb();return n.aabb.contains(r,t)}},f=function(n){return n.next?function(t){for(var i=n;i;){if(!i(t))return!1;i=i.next}return!0}:n},l=function(n){return n.next?function(t){for(var i=n;i;){if(i(t))return!0;i=i.next}return!1}:n},a={$eq:r,$ne:s,$in:u,$nin:h,$at:c},i=function i(t,u){var s,p,v,y,h,c;if(u){if(u==="$or"||u==="$and"){for(s=0,p=t.length;s<p;++s)c=i(t[s]),h=h?h.next=c:y=c;return u==="$or"?l(y):f(y)}if(s=a[u])return s(t);throw"Unknown query operation: "+u;}for(s in t)v=t[s],c=s[0]==="$"?i(v,s):n.util.isPlainObject(v)?o(i(v),s):r(v,s),h=h?h.next=c:y=c;return f(y||e)};n.query=i}(this),function(){var t={priority:0};n.behavior=r("behavior",{init:function(i){this.options=n.util.options(t);this.options(i)},applyTo:function(t){return this._targets=t===!0?null:n.util.uniq(t),this},getTargets:function(){return this._targets||(this._world?this._world._bodies:[])},setWorld:function(n){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=n,this.connect&&n&&this.connect(n),this},connect:function(n){if(this.behave)n.on("integrate:positions",this.behave,this,this.options.priority)},disconnect:function(n){this.behave&&n.off("integrate:positions",this.behave,this)},behave:null})}(),function(){var i={hidden:!1,treatment:"dynamic",mass:1,restitution:1,cof:.8,view:null},u=1,t=Math.PI*2;n.body=r("body",{init:function(t){var f=this,r=n.vector;this.options=n.util.options(i,this);this.options.onChange(function(n){f.offset=new r(n.offset)});if(this.options(t),this.state={pos:new r(this.x,this.y),vel:new r(this.vx,this.vy),acc:new r,angular:{pos:this.angle||0,vel:this.angularVelocity||0,acc:0},old:{pos:new r,vel:new r,acc:new r,angular:{pos:0,vel:0,acc:0}}},this._sleepAngPosMean=0,this._sleepAngPosVariance=0,this._sleepPosMean=new r,this._sleepPosVariance=new r,this._sleepMeanK=0,delete this.x,delete this.y,delete this.vx,delete this.vy,delete this.angle,delete this.angularVelocity,this.mass===0)throw"Error: Bodies must have non-zero mass";this.uid=u++;this.geometry=n.geometry("point")},sleep:function(n){return n===!0?this.asleep=!0:n===!1?(this.asleep=!1,this._sleepMeanK=0,this._sleepAngPosMean=0,this._sleepAngPosVariance=0,this._sleepPosMean.zero(),this._sleepPosVariance.zero(),this.sleepIdleTime=0):n&&!this.asleep&&this.sleepCheck(n),this.asleep},sleepCheck:function(t){var i=this._world&&this._world.options;if(!this.sleepDisabled&&(!i||!i.sleepDisabled)){var r,u,o,s,f=n.scratchpad(),c=f.vector(),l=f.vector(),h,e;if(t=t||0,s=this.geometry.aabb(),o=Math.max(s.hw,s.hh),this.asleep&&(u=this.state.vel.norm()+Math.abs(o*this.state.angular.vel),r=this.sleepSpeedLimit||i&&i.sleepSpeedLimit||0,u>=r))return this.sleep(!1),f.done();this._sleepMeanK++;h=this._sleepMeanK>1?1/(this._sleepMeanK-1):0;n.statistics.pushRunningVectorAvg(this.state.pos,this._sleepMeanK,this._sleepPosMean,this._sleepPosVariance);e=n.statistics.pushRunningAvg(Math.sin(this.state.angular.pos),this._sleepMeanK,this._sleepAngPosMean,this._sleepAngPosVariance);this._sleepAngPosMean=e[0];this._sleepAngPosVariance=e[1];u=this._sleepPosVariance.norm()+Math.abs(o*Math.asin(e[1]));u*=h;r=this.sleepVarianceLimit||i&&i.sleepVarianceLimit||0;u<=r?(r=this.sleepTimeLimit||i&&i.sleepTimeLimit||0,this.sleepIdleTime=(this.sleepIdleTime||0)+t,this.sleepIdleTime>r&&(this.asleep=!0)):this.sleep(!1);f.done()}},setWorld:function(n){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=n,this.connect&&n&&this.connect(n),this},accelerate:function(n){return this.treatment==="dynamic"&&this.state.acc.vadd(n),this},applyForce:function(t,i){if(this.treatment!=="dynamic")return this;var u=n.scratchpad(),r=u.vector(),f;return i&&this.moi&&(f=this.state,r.clone(i),this.state.angular.acc-=r.cross(t)/this.moi),this.accelerate(r.clone(t).mult(1/this.mass)),u.done(),this},getGlobalOffset:function(t){return t=t||new n.vector,t.clone(this.offset).rotate(this.state.angular.pos),t},aabb:function(){var u=this.state.angular.pos,r=n.scratchpad(),t=r.vector(),i=this.geometry.aabb(u);return this.getGlobalOffset(t),i.x+=this.state.pos._[0]+t._[0],i.y+=this.state.pos._[1]+t._[1],r.done(i)},toBodyCoords:function(n){return n.vsub(this.state.pos).rotate(-this.state.angular.pos)},toWorldCoords:function(n){return n.rotate(this.state.angular.pos).vadd(this.state.pos)},recalc:function(){return this}});n.body.getCOM=function(t,i){var r,f,u,e=t&&t.length,o=0;if(i=i||new n.vector,!e)return i.zero();if(e===1)return i.clone(t[0].state.pos);for(i.zero(),u=0;u<e;u++)r=t[u],f=r.state.pos,i.add(f._[0]*r.mass,f._[1]*r.mass),o+=r.mass;return i.mult(1/o),i}}(),function(){n.geometry=r("geometry",{init:function(t){this.options=n.util.options();this.options(t);this._aabb=new n.aabb},aabb:function(){return n.aabb.clone(this._aabb)},getFarthestHullPoint:function(t,i){return i=i||new n.vector,i.set(0,0)},getFarthestCorePoint:function(t,i){return i=i||new n.vector,i.set(0,0)}})}(),n.geometry.regularPolygonVertices=function(n,t){for(var u=[],f=Math.PI*2/n,i=0,r=0;r<n;r++)u.push({x:t*Math.cos(i),y:t*Math.sin(i)}),i+=f;return u},n.geometry.isPolygonConvex=function(t){var r=n.scratchpad(),f=r.vector(),e=r.vector(),h=r.vector(),o=!0,s=!1,i=t.length,u;if(!t||!i)return!1;if(i<3)return r.done(),o;for(f.clone(t[0]).vsub(h.clone(t[i-1])),u=1;u<=i;++u){if(e.clone(t[u%i]).vsub(h.clone(t[(u-1)%i])),s===!1)s=f.cross(e);else if(s>0^f.cross(e)>0){o=!1;break}e.swap(f)}return r.done(),o},n.geometry.getPolygonMOI=function(t){var u=n.scratchpad(),i=u.vector(),r=u.vector(),s=0,h=0,f,o=t.length,e;if(o<2)return u.done(),0;if(o===2)return f=r.clone(t[1]).distSq(i.clone(t[0])),u.done(),f/12;for(i.clone(t[0]),e=1;e<o;++e)r.clone(t[e]),f=Math.abs(r.cross(i)),s+=f*(r.normSq()+r.dot(i)+i.normSq()),h+=f,i.swap(r);return u.done(),s/(6*h)},n.geometry.isPointInPolygon=function(t,i){var u=n.scratchpad(),e=u.vector().clone(t),f=u.vector(),h=u.vector(),r=0,o=i.length,s;if(o<2)return r=e.equals(f.clone(i[0])),u.done(),r;if(o===2)return r=e.angle(f.clone(i[0])),r+=e.angle(f.clone(i[1])),u.done(),Math.abs(r)===Math.PI;for(f.clone(i[0]).vsub(e),s=1;s<=o;++s)h.clone(i[s%o]).vsub(e),r+=h.angle(f),f.swap(h);return u.done(),Math.abs(r)>1e-6},n.geometry.getPolygonArea=function(t){var i=n.scratchpad(),u=i.vector(),f=i.vector(),o=0,e=t.length,r;if(e<3)return i.done(),0;for(u.clone(t[e-1]),r=0;r<e;++r)f.clone(t[r]),o+=u.cross(f),u.swap(f);return i.done(),o/2},n.geometry.getPolygonCentroid=function(t){var i=n.scratchpad(),r=i.vector(),u=i.vector(),s=new n.vector,f,e=t.length,o;if(e<2)return i.done(),new n.vector(t[0]);if(e===2)return i.done(),new n.vector((t[1].x+t[0].x)/2,(t[1].y+t[0].y)/2);for(r.clone(t[e-1]),o=0;o<e;++o)u.clone(t[o]),f=r.cross(u),r.vadd(u).mult(f),s.vadd(r),r.swap(u);return f=1/(6*n.geometry.getPolygonArea(t)),i.done(),s.mult(f)},n.geometry.nearestPointOnLine=function(t,i,r){var u=n.scratchpad(),f=u.vector().clone(t),o=u.vector().clone(i).vsub(f),s=u.vector().clone(r).vsub(f).vsub(o),e,h;return s.equals(n.vector.zero)?(u.done(),new n.vector(i)):(e=-s.dot(o)/s.normSq(),h=1-e,h<=0)?(u.done(),new n.vector(r)):e<=0?(u.done(),new n.vector(i)):(f=new n.vector(r).mult(e).vadd(o.clone(i).mult(h)),u.done(),f)},function(){var t={drag:0};n.integrator=r("integrator",{init:function(i){this.options=n.util.options(t);this.options(i)},setWorld:function(n){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=n,this.connect&&n&&this.connect(n),this},integrate:function(n,t){var i=this._world;return this.integrateVelocities(n,t),i&&i.emit("integrate:velocities",{bodies:n,dt:t}),this.integratePositions(n,t),i&&i.emit("integrate:positions",{bodies:n,dt:t}),this},connect:null,disconnect:null,integrateVelocities:function(){throw"The integrator.integrateVelocities() method must be overriden";},integratePositions:function(){throw"The integrator.integratePositions() method must be overriden";}})}(),function(){var u={meta:!1,metaRefresh:200,width:600,height:600,autoResize:!0};n.renderer=r("renderer",{init:function(r){var e=this,f=typeof r.el=="string"?i.getElementById(r.el):r.el;this.options=n.util.options(u);this.options(r);this.el=f?f:i.body;this.container=f&&f.parentNode?f.parentNode:i.body;this.drawMeta=n.util.throttle(n.util.bind(this.drawMeta,this),this.options.metaRefresh);t.addEventListener("resize",n.util.throttle(function(){e.options.autoResize&&e.resize()}),100)},resize:function(n,t){n===undefined&&t===undefined&&(n=this.container.offsetWidth,t=this.container.offsetHeight);this.width=n||0;this.height=t||0},setWorld:function(n){return this.disconnect&&this._world&&this.disconnect(this._world),this._world=n,this.connect&&n&&this.connect(n),this},render:function(n,t){var i,u,r,f;for(this.beforeRender&&this.beforeRender(),this._world.emit("beforeRender",{renderer:this,bodies:n,meta:t}),this.options.meta&&this.drawMeta(t),this._interpolateTime=t.interpolateTime,r=0,f=n.length;r<f;++r)i=n[r],u=i.view||(i.view=this.createView(i.geometry,i.styles)),i.hidden||this.drawBody(i,u);return this},createView:function(){throw"You must override the renderer.createView() method.";},drawMeta:function(){throw"You must override the renderer.drawMeta() method.";},drawBody:function(){throw"You must override the renderer.drawBody() method.";}})}(),function(){var i=function i(n,t,r){for(var f,u,e=function(){return i(n,t,r)};f=n.shift();)if(u=f.apply(t,r),u&&u.then)return u.then(e)},r={timestep:6,maxIPF:4,webworker:!1,integrator:"verlet",sleepDisabled:!1,sleepSpeedLimit:.05,sleepVarianceLimit:.02,sleepTimeLimit:500},t=function t(n,i){if(!(this instanceof t))return new t(n,i);this.init(n,i)};t.prototype=n.util.extend({},n.util.pubsub.prototype,{init:function(t,u){var f=this;(n.util.isFunction(t)||n.util.isArray(t))&&(u=t,t={});this._meta={fps:0,ipf:0};this._bodies=[];this._behaviors=[];this._integrator=null;this._renderer=null;this._paused=!1;this._warp=1;this._time=0;this.options=n.util.options(r);this.options.onChange(function(n){f.timestep(n.timestep)});this.options(t);this.add(n.integrator(this.options.integrator));n.util.isFunction(u)?i([u],this,[this,n]):n.util.isArray(u)&&i(u,this,[this,n])},options:null,add:function(t){var r=0,u=t&&t.length||0,i=n.util.isArray(t)?t[0]:t;if(!i)return this;do switch(i.type){case"behavior":this.addBehavior(i);break;case"integrator":this.integrator(i);break;case"renderer":this.renderer(i);break;case"body":this.addBody(i);break;default:throw'Error: failed to add item of unknown type "'+i.type+'" to world';}while(++r<u&&(i=t[r]));return this},remove:function(t){var r=0,u=t&&t.length||0,i=n.util.isArray(t)?t[0]:t;if(!i)return this;do switch(i.type){case"behavior":this.removeBehavior(i);break;case"integrator":i===this._integrator&&this.integrator(null);break;case"renderer":i===this._renderer&&this.renderer(null);break;case"body":this.removeBody(i);break;default:throw'Error: failed to remove item of unknown type "'+i.type+'" from world';}while(++r<u&&(i=t[r]));return this},has:function(t){var i;if(!t)return!1;switch(t.type){case"behavior":i=this._behaviors;break;case"integrator":return this._integrator===t;case"renderer":return this._renderer===t;case"body":i=this._bodies;break;default:throw'Error: unknown type "'+t.type+'"';}return n.util.indexOf(i,t)>-1},integrator:function(n){return n===undefined?this._integrator:this._integrator===n?this:(this._integrator&&(this._integrator.setWorld(null),this.emit("remove:integrator",{integrator:this._integrator})),n&&(this._integrator=n,this._integrator.setWorld(this),this.emit("add:integrator",{integrator:this._integrator})),this)},renderer:function(n){return n===undefined?this._renderer:this._renderer===n?this:(this._renderer&&(this._renderer.setWorld(null),this.emit("remove:renderer",{renderer:this._renderer})),n&&(this._renderer=n,this._renderer.setWorld(this),this.emit("add:renderer",{renderer:this._renderer})),this)},timestep:function(n){return n?(this._dt=+n.toPrecision(4),this._maxJump=n*this.options.maxIPF,this):this._dt},wakeUpAll:function(){for(var n=0,t=this._bodies.length,n=0;n<t;n++)this._bodies[n].sleep(!1)},addBehavior:function(n){return this.has(n)?this:(n.setWorld(this),this._behaviors.push(n),this.emit("add:behavior",{behavior:n}),this)},getBehaviors:function(){return[].concat(this._behaviors)},removeBehavior:function(n){var i=this._behaviors,t,r;if(n)for(t=0,r=i.length;t<r;++t)if(n===i[t]){i.splice(t,1);n.setWorld(null);this.emit("remove:behavior",{behavior:n});break}return this},addBody:function(n){return this.has(n)?this:(n.setWorld(this),this._bodies.push(n),this.emit("add:body",{body:n}),this)},getBodies:function(){return[].concat(this._bodies)},removeBody:function(n){var i=this._bodies,t,r;if(n)for(t=0,r=i.length;t<r;++t)if(n===i[t]){i.splice(t,1);n.setWorld(null);this.emit("remove:body",{body:n});break}return this},findOne:function(t){var i=this,r=typeof t=="function"?t:n.query(t);return n.util.find(i._bodies,r)||!1},find:function(t){var i=this,r=typeof t=="function"?t:n.query(t);return n.util.filter(i._bodies,r)},iterate:function(n){this._integrator.integrate(this._bodies,n)},step:function(t){var i=this._time,h=this._warp,c=1/h,r=this._dt,l=r*c,o=this._maxJump*c,f,s,e,u=this._meta;if(this._paused||this._animTime===undefined)return this._animTime=t||this._animTime||n.util.ticker.now(),this._paused||this.emit("step",u),this;if(t=t||this._animTime+l,f=t-this._animTime,f>o&&(this._animTime=t-o,f=o),s=f*h,e=i+s-r,this.emit("beforeStep"),i<=e)while(i<=e)i+=r,this._animTime+=l,this._time=i,this.iterate(r);return u.fps=1e3/(t-this._lastTime),u.ipf=(s/r).toFixed(2),u.interpolateTime=r+e-i,this._lastTime=t,this.emit("step",u),this},warp:function(n){return n===undefined?this._warp:(this._warp=n||1,this)},render:function(){if(!this._renderer)throw"No renderer added to world";return this._renderer.render(this._bodies,this._meta),this.emit("render",{bodies:this._bodies,meta:this._meta,renderer:this._renderer}),this},pause:function(){return this._paused=!0,this.emit("pause"),this},unpause:function(){return this._paused=!1,this.emit("unpause"),this},isPaused:function(){return!!this._paused},destroy:function(){var n=this;n.pause();this.emit("destroy");n.off(!0);n.remove(n.getBodies());n.remove(n.getBehaviors());n.integrator(null);n.renderer(null)}});n.world=t}(),n.integrator("verlet",function(t){return n.body.mixin({started:function(n){return n!==undefined&&(this._started=!0),!!this._started}}),{init:function(n){t.init.call(this,n)},integrateVelocities:function(n,t){for(var o=t*t,f=1-this.options.drag,r=null,i,s=this.prevDt||t,e=(o+t*s)*.5,u=0,h=n.length;u<h;++u)r=n[u],i=r.state,r.treatment==="static"||r.sleep(t)?(i.vel.zero(),i.acc.zero(),i.angular.vel=0,i.angular.acc=0):(i.vel.equals(i.old.vel)&&r.started()?i.vel.clone(i.pos).vsub(i.old.pos):(i.old.pos.clone(i.pos).vsub(i.vel),i.vel.mult(t)),f&&i.vel.mult(f),i.vel.vadd(i.acc.mult(e)),i.vel.mult(1/t),i.old.vel.clone(i.vel),i.acc.zero(),i.angular.vel===i.old.angular.vel&&r.started()?i.angular.vel=i.angular.pos-i.old.angular.pos:(i.old.angular.pos=i.angular.pos-i.angular.vel,i.angular.vel*=t),i.angular.vel+=i.angular.acc*e,i.angular.vel/=t,i.old.angular.vel=i.angular.vel,i.angular.acc=0,r.started(!0))},integratePositions:function(n,t){for(var s=t*t,r=null,i,e=this.prevDt||t,u=t/e,f=0,o=n.length;f<o;++f)r=n[f],i=r.state,r.treatment==="static"||r.sleep()||(i.vel.mult(t*u),i.old.pos.clone(i.pos),i.pos.vadd(i.vel),i.vel.mult(1/(t*u)),i.old.vel.clone(i.vel),i.angular.vel*=t*u,i.old.angular.pos=i.angular.pos,i.angular.pos+=i.angular.vel,i.angular.vel/=t*u,i.old.angular.vel=i.angular.vel);this.prevDt=t}}}),n.geometry("point",function(){}),n.body("point",function(n){return{init:function(t){n.init.call(this,t);this.moi=0}}}),n.geometry("circle",function(t){var i={radius:1};return{init:function(r){var u=this;t.init.call(this,r);this.options.defaults(i);this.options.onChange(function(n){this.radius=n.radius});this.options(r);this._aabb=n.aabb();this.radius=this.options.radius},aabb:function(){var t=this.radius;return this._aabb.hw!==t&&(this._aabb=n.aabb(-t,-t,t,t)),n.aabb.clone(this._aabb)},getFarthestHullPoint:function(t,i){return i=i||new n.vector,i.clone(t).normalize().mult(this.radius)},getFarthestCorePoint:function(t,i,r){return i=i||new n.vector,i.clone(t).normalize().mult(this.radius-r)}}}),n.geometry("compound",function(t){var i={};return{init:function(n){var r=this;t.init.call(this,n);this.options.defaults(i);this.options(n);this.children=[]},addChild:function(t,i,r){return this._aabb=null,this.children.push({g:t,pos:new n.vector(i),angle:r}),this},clear:function(){return this._aabb=null,this.children=[],this},aabb:function(t){var i,f,r,o,u,e,s;if(!t&&this._aabb)return n.aabb.clone(this._aabb);for(o=n.scratchpad(),u=n.vector(),t=t||0,e=0,s=this.children.length;e<s;e++)f=this.children[e],i=f.g.aabb(t+f.angle),u.clone(f.pos),t&&u.rotate(t),i.x+=u._[0],i.y+=u._[1],r=r?n.aabb.union(r,i,!0):i;return t||(this._aabb=n.aabb.clone(r)),o.done(r)},getFarthestHullPoint:function(t,i){var r,u,h=this.children.length,o=n.scratchpad(),f=o.vector(),e=0,s=0;for(i=i||new n.vector,u=0;u<h;u++)r=this.children[u],r.g.getFarthestHullPoint(t.rotate(-r.angle),f),e=f.rotate(r.angle).vadd(r.pos).proj(t.rotate(r.angle)),e>s&&(s=e,i.swap(f));return o.done(i)},getFarthestCorePoint:function(t,i,r){var u,f,c=this.children.length,s=n.scratchpad(),e=s.vector(),o=0,h=0;for(i=i||new n.vector,f=0;f<c;f++)u=this.children[f],u.g.getFarthestCorePoint(t.rotate(-u.angle),e,r),o=e.rotate(u.angle).vadd(u.pos).proj(t.rotate(u.angle)),o>h&&(h=o,i.swap(e));return s.done(i)}}}),n.geometry("convex-polygon",function(t){var i="Error: The vertices specified do not match that of a _convex_ polygon.",r={};return{init:function(n){var i=this;t.init.call(this,n);this.options.defaults(r);this.options.onChange(function(n){i.setVertices(n.vertices||[])});this.options(n);i.setVertices(this.options.vertices||[])},setVertices:function(t){var f=n.scratchpad(),u=f.transform(),e=this.vertices=[],r,o;if(!n.geometry.isPolygonConvex(t))throw i;for(u.setRotation(0),u.setTranslation(n.geometry.getPolygonCentroid(t).negate()),r=0,o=t.length;r<o;++r)e.push(new n.vector(t[r]).translate(u));return this._area=n.geometry.getPolygonArea(e),this._aabb=!1,f.done(this)},aabb:function(t){if(!t&&this._aabb)return n.aabb.clone(this._aabb);var i=n.scratchpad(),r=i.vector(),o=i.transform().setRotation(t||0),u=i.vector().set(1,0).rotateInv(o),f=i.vector().set(0,1).rotateInv(o),s=this.getFarthestHullPoint(u,r).proj(u),h=-this.getFarthestHullPoint(u.negate(),r).proj(u),c=this.getFarthestHullPoint(f,r).proj(f),l=-this.getFarthestHullPoint(f.negate(),r).proj(f),e;return e=n.aabb(h,l,s,c),t||(this._aabb=n.aabb.clone(e)),i.done(),e},getFarthestHullPoint:function(t,i,r){var f=this.vertices,e,o,h=f.length,u=2,s;if(i=i||new n.vector,h<2)return r&&(r.idx=0),i.clone(f[0]);if(o=f[0].dot(t),e=f[1].dot(t),h===2)return s=e>=o?1:0,r&&(r.idx=s),i.clone(f[s]);if(e>=o){while(u<h&&e>=o)o=e,e=f[u].dot(t),u++;return e>=o&&u++,s=u-2,r&&(r.idx=u-2),i.clone(f[s])}for(u=h;u>1&&o>=e;)u--,e=o,o=f[u].dot(t);return s=(u+1)%h,r&&(r.idx=s),i.clone(f[s])},getFarthestCorePoint:function(t,i,r){var u=n.scratchpad(),f=u.vector(),e=u.vector(),o=this.vertices,s=o.length,c,l=this._area>0,h={};return i=this.getFarthestHullPoint(t,i,h),f.clone(o[(h.idx+1)%s]).vsub(i).normalize().perp(l),e.clone(o[(h.idx-1+s)%s]).vsub(i).normalize().perp(!l),c=r/(1+f.dot(e)),i.vadd(f.vadd(e).mult(c)),u.done(),i}}}),n.geometry("rectangle",function(t){var i={};return{init:function(n){var r=this;t.init.call(this,n);this.options.defaults(i);this.options.onChange(function(){r.width=r.options.width||1;r.height=r.options.height||1});this.options(n)},aabb:function(t){if(!t)return n.aabb(this.width,this.height);var i=n.scratchpad(),r=i.vector(),e=i.transform().setRotation(t||0),u=i.vector().set(1,0).rotateInv(e),f=i.vector().set(0,1).rotateInv(e),o=this.getFarthestHullPoint(u,r).proj(u),s=-this.getFarthestHullPoint(u.negate(),r).proj(u),h=this.getFarthestHullPoint(f,r).proj(f),c=-this.getFarthestHullPoint(f.negate(),r).proj(f);return i.done(),n.aabb(s,c,o,h)},getFarthestHullPoint:function(t,i){i=i||new n.vector;var r=t.x,u=t.y;return r=r===0?0:r<0?-this.width*.5:this.width*.5,u=u===0?0:u<0?-this.height*.5:this.height*.5,i.set(r,u)},getFarthestCorePoint:function(n,t,i){var r,u;return t=this.getFarthestHullPoint(n,t),r=t.x,u=t.y,t.x=r===0?0:r<0?r+i:r-i,t.y=u===0?0:u<0?u+i:u-i,t}}}),n.body("circle",function(t){var i={radius:1};return{init:function(r){t.init.call(this,r);r=n.util.extend({},i,r);this.geometry=n.geometry("circle",{radius:r.radius});this.recalc()},recalc:function(){t.recalc.call(this);this.moi=this.mass*this.geometry.radius*this.geometry.radius/2}}}),n.body("compound",function(t){return{init:function(i){t.init.call(this,i);this.mass=0;this.moi=0;this.children=[];this.geometry=n.geometry("compound");this.addChildren(i.children)},connect:function(){if(this.mass<=0)throw"Can not add empty compound body to world.";},addChild:function(n){return this.addChildren([n]),this},addChildren:function(t){var h=this,u=n.scratchpad(),f=u.vector().zero(),i,e,r,o=t&&t.length,s=0;if(!o)return u.done(this);for(r=0;r<o;r++)i=t[r],i._world&&i._world.remove(i),this.children.push(i),this.geometry.addChild(i.geometry,new n.vector(i.offset).rotate(i.state.angular.pos).vadd(i.state.pos),i.state.angular.pos),e=i.state.pos,f.add(e._[0]*i.mass,e._[1]*i.mass),s+=i.mass;if(this.mass+=s,f.mult(1/this.mass),this.offset.vsub(f),this._world)this._world.one("render",function(){h.view=null});return this.recalc(),u.done(this)},clear:function(){return this._aabb=null,this.moi=0,this.mass=0,this.offset.zero(),this.children=[],this.geometry.clear(),this},refreshGeometry:function(){this.geometry.clear();for(var i=0,t,r=this.children.length;i<r;i++)t=this.children[i],this.geometry.addChild(t.geometry,new n.vector(t.state.pos).vadd(t.offset),t.state.angular.pos);return this},recalc:function(){var n,r,i,u;for(t.recalc.call(this),r=0,i=0,u=this.children.length;i<u;i++)n=this.children[i],n.recalc(),r+=n.moi+n.mass*n.state.pos.normSq();return this.moi=r,this}}}),n.body("convex-polygon",function(t){var i={};return{init:function(r){t.init.call(this,r);r=n.util.extend({},i,r);this.geometry=n.geometry("convex-polygon",{vertices:r.vertices});this.recalc()},recalc:function(){t.recalc.call(this);this.moi=n.geometry.getPolygonMOI(this.geometry.vertices)}}}),n.body("rectangle",function(t){var i={};return{init:function(r){t.init.call(this,r);r=n.util.extend({},i,r);this.geometry=n.geometry("rectangle",{width:r.width,height:r.height});this.recalc()},recalc:function(){var n=this.geometry.width,i=this.geometry.height;t.recalc.call(this);this.moi=(n*n+i*i)*this.mass/12}}}),n.behavior("attractor",function(t){var i={pos:null,strength:1,order:2,max:!1,min:!1};return{init:function(r){var u=this;this._pos=new n.vector;t.init.call(this);this.options.defaults(i);this.options.onChange(function(n){u._maxDist=n.max===!1?Infinity:n.max;u._minDist=n.min?n.min:10;u.position(n.pos)});this.options(r)},position:function(n){var t=this;return n?(this._pos.clone(n),t):this._pos.values()},behave:function(){for(var f=this.getTargets(),r,s=this.options.order,h=this.options.strength,c=this._minDist,l=this._maxDist,e=n.scratchpad(),t=e.vector(),i,o,u=0,a=f.length;u<a;u++)r=f[u],t.clone(this._pos),t.vsub(r.state.pos),i=t.norm(),i>c&&i<l&&(o=h/Math.pow(i,s),r.accelerate(t.normalize().mult(o)));e.done()}}}),n.behavior("body-collision-detection",function(t){var r=[],u=function(t,i){var f=n.util.pairHash(t.uid,i.uid),u=r[f];return u||(u=r[f]=function(n){var e=u.tA,o=u.tB,r=u.tmpv1,f=u.tmpv2;return u.useCore?(r=t.geometry.getFarthestCorePoint(n.rotateInv(e),r,u.marginA),f=i.geometry.getFarthestCorePoint(n.rotate(e).rotateInv(o).negate(),f,u.marginB)):(r=t.geometry.getFarthestHullPoint(n.rotateInv(e),r),f=i.geometry.getFarthestHullPoint(n.rotate(e).rotateInv(o).negate(),f)),r.vadd(t.offset).transform(e),f.vadd(i.offset).transform(o),n.negate().rotate(o),{a:r.values(),b:f.values(),pt:r.vsub(f).values()}},u.tA=new n.transform,u.tB=new n.transform,u.tmpv1=new n.vector,u.tmpv2=new n.vector),u.useCore=!1,u.margin=0,u.tA.setRotation(t.state.angular.pos).setTranslation(t.state.pos),u.tB.setRotation(i.state.angular.pos).setTranslation(i.state.pos),u.bodyA=t,u.bodyB=i,u},f=function(t,i){var s=n.scratchpad(),o=s.vector(),v=s.vector(),y=s.vector(),h,f,r,c,e=!1,p=t.aabb(),l=Math.min(p.hw,p.hh),w=i.aabb(),a=Math.min(w.hw,w.hh);if(r=u(t,i),o.clone(t.state.pos).vadd(t.getGlobalOffset(y)).vsub(i.state.pos).vsub(i.getGlobalOffset(y)),f=n.gjk(r,o,!0),f.overlap){for(e={bodyA:t,bodyB:i},c=.01*Math.min(l||1,a||1),r.useCore=!0,r.marginA=0,r.marginB=0;(f.overlap||f.distance===0)&&(r.marginA<l||r.marginB<a);)r.marginA<l&&(r.marginA+=c),r.marginB<a&&(r.marginB+=c),f=n.gjk(r,o);if(f.overlap||f.maxIterationsReached||(h=r.marginA+r.marginB-f.distance,h<=0))return s.done(!1);e.overlap=h;e.norm=o.clone(f.closest.b).vsub(v.clone(f.closest.a)).normalize().values();e.mtv=o.mult(h).values();e.pos=o.clone(e.norm).mult(r.marginA).vadd(v.clone(f.closest.a)).vsub(t.state.pos).values()}return s.done(e)},e=function(t,i){var f=n.scratchpad(),r=f.vector(),e=f.vector(),u,o=!1;return r.clone(i.state.pos).vadd(i.getGlobalOffset(e)).vsub(t.state.pos).vsub(t.getGlobalOffset(e)),u=r.norm()-(t.geometry.radius+i.geometry.radius),r.equals(n.vector.zero)&&r.set(1,0),u<=0&&(o={bodyA:t,bodyB:i,norm:r.normalize().values(),mtv:r.mult(-u).values(),pos:r.mult(-t.geometry.radius/u).vadd(e).values(),overlap:-u}),f.done(o)},i=function i(t,r){var a,h,k;if((t.treatment==="static"||t.treatment==="kinematic")&&(r.treatment==="static"||r.treatment==="kinematic"))return!1;if(t.geometry.name==="circle"&&r.geometry.name==="circle")return e(t,r);if(t.geometry.name==="compound"||r.geometry.name==="compound"){for(var p=t.geometry.name==="compound",o=p?t:r,w=p?r:t,s,u,v=[],y=n.scratchpad(),g=y.vector(),c=y.vector(),d=w.aabb(),l=0,b=o.children.length;l<b;l++){if(u=o.children[l],c.clone(u.state.pos),u.offset.vadd(c.vadd(o.offset).rotate(-u.state.angular.pos)),u.state.pos.clone(o.state.pos),u.state.angular.pos+=o.state.angular.pos,n.aabb.overlap(d,u.aabb()))if(s=i(w,u),s instanceof Array)for(a=0,k=s.length;a<k;a++)h=s[a],h.bodyA===u?h.bodyA=o:h.bodyB=o,v.push(h);else s&&(s.bodyA===u?s.bodyA=o:s.bodyB=o,v.push(s));u.state.angular.pos-=o.state.angular.pos;u.offset.vsub(c);u.state.pos.clone(c.rotate(u.state.angular.pos).vsub(o.offset))}return y.done(v)}return f(t,r)},o={check:"collisions:candidates",channel:"collisions:detected"};return{init:function(n){t.init.call(this);this.options.defaults(o);this.options(n)},connect:function(n){if(this.options.check===!0)n.on("integrate:velocities",this.checkAll,this);else n.on(this.options.check,this.check,this)},disconnect:function(n){this.options.check===!0?n.off("integrate:velocities",this.checkAll,this):n.off(this.options.check,this.check,this)},check:function(t){for(var o,s,p,a=t.candidates,r,h=this.getTargets(),e=[],u,v=this.prevContacts||{},c={},y=n.util.pairHash,f,l=0,w=a.length;l<w;++l)if(r=a[l],h===this._world._bodies||n.util.indexOf(h,r.bodyA)>-1&&n.util.indexOf(h,r.bodyB)>-1)if(u=i(r.bodyA,r.bodyB),u instanceof Array)for(o=0,p=u.length;o<p;o++)s=u[o],s&&(f=y(r.bodyA.uid,r.bodyB.uid),c[f]=!0,s.collidedPreviously=v[f],e.push(s));else u&&(f=y(r.bodyA.uid,r.bodyB.uid),c[f]=!0,u.collidedPreviously=v[f],e.push(u));this.prevContacts=c;e.length&&this._world.emit(this.options.channel,{collisions:e})},checkAll:function(t){for(var h,c,l,b,a=this.getTargets(),k=t.dt,f,e,o=[],r,y=this.prevContacts||{},v={},p=n.util.pairHash,u,s=0,w=a.length;s<w;s++)for(f=a[s],h=s+1;h<w;h++)if(e=a[h],r=i(f,e),r instanceof Array)for(c=0,b=r.length;c<b;c++)l=r[c],l&&(u=p(f.uid,e.uid),v[u]=!0,l.collidedPreviously=y[u],o.push(l));else r&&(u=p(f.uid,e.uid),v[u]=!0,r.collidedPreviously=y[u],o.push(r));this.prevContacts=v;o.length&&this._world.emit(this.options.channel,{collisions:o})}}}),n.behavior("body-impulse-response",function(t){function u(n){return n.uid}function i(n,t,i){var u,r;return r=t.norm(),u=r-n.proj(t),u=Math.max(0,Math.min(r,u)),r===0?i.zero():i.clone(t).mult(u/r),i}var r={check:"collisions:detected",mtvThreshold:1,bodyExtractDropoff:.5,forceWakeupAboveOverlapThreshold:!0};return{init:function(n){t.init.call(this);this.options.defaults(r);this.options(n);this._bodyList=[]},applyTo:!1,connect:function(n){n.on(this.options.check,this.respond,this)},disconnect:function(n){n.off(this.options.check,this.respond,this)},collideBodies:function(t,r,u,f,e,o){var w=t.treatment==="static"||t.treatment==="kinematic",b=r.treatment==="static"||r.treatment==="kinematic",h=n.scratchpad(),y=h.vector().clone(e);if(w&&b){h.done();return}var l=w?0:1/t.moi,a=b?0:1/r.moi,k=w?0:1/t.mass,d=b?0:1/r.mass,at=t.restitution*r.restitution,ot=t.cof*r.cof,v=h.vector().clone(u),p=h.vector().clone(v).perp(),c=h.vector(),rt=h.vector().clone(f),ut=h.vector().clone(f).vadd(t.state.pos).vsub(r.state.pos),vt=t.state.angular.vel,yt=r.state.angular.vel,st=h.vector().clone(r.state.vel).vadd(c.clone(ut).perp().mult(yt)).vsub(t.state.vel).vsub(c.clone(rt).perp().mult(vt)),g=rt.proj(v),nt=rt.proj(p),tt=ut.proj(v),it=ut.proj(p),ht=st.proj(v),ft=st.proj(p),s,ct,lt,et,pt=o;if(o&&(w?(i(r._mtvTotal,y,c),r._mtvTotal.vadd(c)):b?(i(t._mtvTotal,y.negate(),c),t._mtvTotal.vadd(c),y.negate()):(et=.5,y.mult(et),i(r._mtvTotal,y,c),r._mtvTotal.vadd(c),y.clone(e).mult(et-1),i(t._mtvTotal,y,c),t._mtvTotal.vadd(c))),ht>=0){h.done();return}l=l===Infinity?0:l;a=a===Infinity?0:a;s=-((1+at)*ht)/(k+d+l*nt*nt+a*it*it);w?(r.state.vel.vadd(v.mult(s*d)),r.state.angular.vel-=s*a*it):b?(t.state.vel.vsub(v.mult(s*k)),t.state.angular.vel+=s*l*nt):(r.state.vel.vadd(v.mult(s*d)),r.state.angular.vel-=s*a*it,t.state.vel.vsub(v.mult(k*r.mass)),t.state.angular.vel+=s*l*nt);ot&&ft&&(lt=Math.abs(ft)/(k+d+l*g*g+a*tt*tt),ct=ft<0?-1:1,s=ot*Math.abs(s),s=Math.min(s,lt),s*=ct,w?(r.state.vel.vsub(p.mult(s*d)),r.state.angular.vel-=s*a*tt):b?(t.state.vel.vadd(p.mult(s*k)),t.state.angular.vel+=s*l*g):(r.state.vel.vsub(p.mult(s*d)),r.state.angular.vel-=s*a*tt,t.state.vel.vadd(p.mult(k*r.mass)),t.state.angular.vel+=s*l*g));t.sleep()&&t.sleepCheck();r.sleep()&&r.sleepCheck();h.done()},_pushUniq:function(t){var i=n.util.sortedIndex(this._bodyList,t,u);this._bodyList[i]!==t&&this._bodyList.splice(i,0,t)},respond:function(t){for(var o=this,i,e=t.collisions,r,u=0,f=e.length;u<f;++u)i=e[u],this._pushUniq(i.bodyA),this._pushUniq(i.bodyB),i.bodyA._mtvTotal=i.bodyA._mtvTotal||new n.vector,i.bodyB._mtvTotal=i.bodyB._mtvTotal||new n.vector,i.bodyA._oldmtvTotal=i.bodyA._oldmtvTotal||new n.vector,i.bodyB._oldmtvTotal=i.bodyB._oldmtvTotal||new n.vector,o.collideBodies(i.bodyA,i.bodyB,i.norm,i.pos,i.mtv,i.collidedPreviously);for(u=0,f=this._bodyList.length;u<f;++u)r=this._bodyList.pop(),r._mtvTotal.normSq()<this.options.mtvThreshold?r._mtvTotal.mult(this.options.bodyExtractDropoff):this.options.forceWakeupAboveOverlapThreshold&&r.sleep(!1),r.state.pos.vadd(r._mtvTotal),r.state.old.pos.vadd(r._mtvTotal),r._oldmtvTotal.swap(r._mtvTotal),r._mtvTotal.zero()}}}),n.behavior("constant-acceleration",function(t){var i={acc:{x:0,y:.0004}};return{init:function(r){t.init.call(this);this.options.defaults(i);this.options(r);this._acc=new n.vector;this.setAcceleration(this.options.acc);delete this.options.acc},setAcceleration:function(n){return this._acc.clone(n),this},behave:function(){for(var t=this.getTargets(),n=0,i=t.length;n<i;++n)t[n].accelerate(this._acc)}}}),n.behavior("edge-collision-detection",function(t){var i=function(t,i,r){var u,f=t.aabb(),h=n.scratchpad(),l=t.getGlobalOffset(h.vector()),e=h.transform(),o=h.vector(),a=h.vector(),s=!1,c=[];return u=f.x+f.hw-i.max.x,u>=0&&(o.set(1,0).rotateInv(e.setRotation(t.state.angular.pos)),s={bodyA:t,bodyB:r,overlap:u,norm:{x:1,y:0},mtv:{x:u,y:0},pos:t.geometry.getFarthestHullPoint(o,a).rotate(e).vadd(l).values()},c.push(s)),u=f.y+f.hh-i.max.y,u>=0&&(o.set(0,1).rotateInv(e.setRotation(t.state.angular.pos)),s={bodyA:t,bodyB:r,overlap:u,norm:{x:0,y:1},mtv:{x:0,y:u},pos:t.geometry.getFarthestHullPoint(o,a).rotate(e).vadd(l).values()},c.push(s)),u=i.min.x-(f.x-f.hw),u>=0&&(o.set(-1,0).rotateInv(e.setRotation(t.state.angular.pos)),s={bodyA:t,bodyB:r,overlap:u,norm:{x:-1,y:0},mtv:{x:-u,y:0},pos:t.geometry.getFarthestHullPoint(o,a).rotate(e).vadd(l).values()},c.push(s)),u=i.min.y-(f.y-f.hh),u>=0&&(o.set(0,-1).rotateInv(e.setRotation(t.state.angular.pos)),s={bodyA:t,bodyB:r,overlap:u,norm:{x:0,y:-1},mtv:{x:0,y:-u},pos:t.geometry.getFarthestHullPoint(o,a).rotate(e).vadd(l).values()},c.push(s)),h.done(),c},r=function(n,t,r){return i(n,t,r)},u={aabb:null,restitution:.99,cof:1,channel:"collisions:detected"};return{init:function(i){t.init.call(this);this.options.defaults(u);this.options(i);this.setAABB(this.options.aabb);this.restitution=this.options.restitution;this.body=n.body("point",{treatment:"static",restitution:this.options.restitution,cof:this.options.cof})},setAABB:function(n){if(!n)throw"Error: aabb not set";return this._edges={min:{x:n.x-n.hw,y:n.y-n.hh},max:{x:n.x+n.hw,y:n.y+n.hh}},this},connect:function(n){n.on("integrate:positions",this.checkAll,this,2)},disconnect:function(n){n.off("integrate:positions",this.checkAll,this,2)},checkAll:function(t){for(var e,a,h=this.getTargets(),b=t.dt,u,f=[],i,v=this._edges,c=this.body,y=this.prevContacts||{},l={},p=n.util.pairHash,o,s=0,w=h.length;s<w;s++)if(u=h[s],u.treatment==="dynamic"&&(i=r(u,v,c),i)){for(o=p(u.uid,c.uid),e=0,a=i.length;e<a;e++)l[o]=!0,i[e].collidedPreviously=y[o];f.push.apply(f,i)}this.prevContacts=l;f.length&&this._world.emit(this.options.channel,{collisions:f})}}}),n.behavior("interactive",function(r){if(!i)return{};var f={el:null,moveThrottle:10,minVel:{x:-5,y:-5},maxVel:{x:5,y:5}},u=function(n){var t=0,i=0;if(n.offsetParent)do t+=n.offsetLeft,i+=n.offsetTop;while(n=n.offsetParent);return{left:t,top:i}};return{init:function(t){var e=this;if(r.init.call(this),this.options.defaults(f),this.options(t),this.bodyData={},this.bodyDataByUID={},this.el=typeof this.options.el=="string"?i.getElementById(this.options.el):this.options.el,!this.el)throw"No DOM element specified";e.grab=function(t){var f,r,s,o,c,i,h,l;if(e._world)for(t.changedTouches||(t.changedTouches=[t]),c=u(t.target),h=0,l=t.changedTouches.length;h<l;h++)o=t.changedTouches[h],s=o.identifier||o.pointerId||"mouse",f={idx:s,x:o.pageX-c.left,y:o.pageY-c.top},r=e._world.findOne({$at:new n.vector(f),$in:e.getTargets()}),r?(r.state.vel.zero(),r.state.angular.vel=0,r.isGrabbed=!0,i=e.bodyData[s]||{},i.body=r,r.sleep(!1),i.time=n.util.ticker.now(),i.treatment=e.bodyDataByUID[r.uid]?e.bodyDataByUID[r.uid].treatment:r.treatment,r.treatment="kinematic",i.pos=i.pos||new n.vector,i.pos.clone(f),i.offset=i.offset||new n.vector,i.offset.clone(f).vsub(r.state.pos),i.oldPos=i.oldPos||new n.vector,i.oldPos.clone(f),f.body=r,e.bodyData[s]=i,e.bodyDataByUID[r.uid]=i,e._world.emit("interact:grab",f)):e._world.emit("interact:poke",f)};e.move=n.util.throttle(function(t){var f,s,h,r,c,i,o,l;if(e._world)for(t.changedTouches||(t.changedTouches=[t]),c=u(e.el),o=0,l=t.changedTouches.length;o<l;o++)r=t.changedTouches[o],h=r.identifier||r.pointerId||"mouse",f={idx:h,x:r.pageX-c.left,y:r.pageY-c.top},i=e.bodyData[h],i&&(s=i.body,s.sleep(!1),i.time=n.util.ticker.now(),i.oldPos.clone(i.pos),i.pos.clone(f),f.body=s),e._world.emit("interact:move",f)},e.options.moveThrottle);e.release=function(t){var o,i,s,f,c,r,l,h,a;if(e._world)for(t.changedTouches||(t.changedTouches=[t]),h=0,a=t.changedTouches.length;h<a;h++)c=u(e.el),f=t.changedTouches[h],s=f.identifier||f.pointerId||"mouse",o={idx:s,x:f.pageX-c.left,y:f.pageY-c.top},r=e.bodyData[s],r&&(i=r.body,i.sleep(!1),r.pos.clone(o),l=Math.max(n.util.ticker.now()-r.time,e.options.moveThrottle),i.treatment=r.treatment,i.state.vel.clone(r.pos).vsub(r.oldPos).mult(1/l),i.state.vel.clamp(e.options.minVel,e.options.maxVel),i.isGrabbed=!1,o.body=i,delete i.isGrabbed),e._world.emit("interact:release",o),delete e.bodyData[s]}},connect:function(n){n.on("integrate:positions",this.behave,this);t.PointerEvent?(this.el.addEventListener("pointerdown",this.grab),t.addEventListener("pointermove",this.move),t.addEventListener("pointerup",this.release)):(this.el.addEventListener("mousedown",this.grab),this.el.addEventListener("touchstart",this.grab),t.addEventListener("mousemove",this.move),t.addEventListener("touchmove",this.move),t.addEventListener("mouseup",this.release),t.addEventListener("touchend",this.release))},disconnect:function(n){n.off("integrate:positions",this.behave,this);t.PointerEvent?(this.el.removeEventListener("pointerdown",this.grab),t.removeEventListener("pointermove",this.move),t.removeEventListener("pointerup",this.release)):(this.el.removeEventListener("mousedown",this.grab),this.el.removeEventListener("touchstart",this.grab),t.removeEventListener("mousemove",this.move),t.removeEventListener("touchmove",this.move),t.removeEventListener("mouseup",this.release),t.removeEventListener("touchend",this.release))},behave:function(n){var i=this,r,f=Math.max(n.dt,i.options.moveThrottle),u,t;for(var e in i.bodyData)t=i.bodyData[e],u=t.body,r=u.state,r.vel.clone(t.pos).vsub(t.offset).vsub(r.pos).mult(1/f)}}}),n.behavior("newtonian",function(t){var i={strength:1,max:!1,min:!1};return{init:function(n){var r=this;t.init.call(this);this.options.defaults(i);this.options.onChange(function(n){r._maxDistSq=n.max===!1?Infinity:n.max*n.max;r._minDistSq=n.min?n.min*n.min:100*n.strength});this.options(n)},calcPotential:function(t,i,r){var o=this.options.strength,s=this._minDistSq,h=this._maxDistSq,f,e,u;return(u=r||new n.vector,u.clone(i).vsub(t),f=u.normSq(),f>s&&f<h)?(e=o/f,u.normalize().mult(e)):u.zero()},behave:function(){for(var y=this.getTargets(),f,t,s=n.scratchpad(),r=s.vector(),i,e,h,c=s.vector(),w=s.vector(),l,u,a,v,b,o=0,p=y.length;o<p;o++)for(f=y[o],l=o+1;l<p;l++){if(t=y[l],f.name==="compound"?i=f:t.name==="compound"&&(i=t,t=f),i)if(t.name==="compound")for(u=0,v=i.children.length;u<v;u++)for(e=i.children[u],i.toWorldCoords(c.clone(e.state.pos).vadd(i.offset)),a=0,b=t.children.length;a<b;a++)h=t.children[a],t.toWorldCoords(w.clone(h.state.pos).vadd(t.offset)),this.calcPotential(c,w,r),i.accelerate(r.mult(h.mass)),t.accelerate(r.mult(e.mass/h.mass).negate());else for(u=0,v=i.children.length;u<v;u++)e=i.children[u],i.toWorldCoords(c.clone(e.state.pos).vadd(i.offset)),this.calcPotential(c,t.state.pos,r),i.accelerate(r.mult(t.mass)),t.accelerate(r.mult(e.mass/t.mass).negate());else this.calcPotential(f.state.pos,t.state.pos,r),f.accelerate(r.mult(t.mass)),t.accelerate(r.mult(f.mass/t.mass).negate());i=null}s.done()}}}),n.behavior("sweep-prune",function(t){var u=1,f=function(){return u++},r={x:0,y:1},i=2,e=n.util.pairHash;return{init:function(n){t.init.call(this);this.options.defaults({channel:"collisions:candidates"});this.options(n);this.encounters=[];this.candidates=[];this.clear()},clear:function(){this.tracked=[];this.pairs=[];this.intervalLists=[];for(var n=0;n<i;++n)this.intervalLists[n]=[]},connect:function(n){var i,t,r;n.on("add:body",this.trackBody,this);n.on("remove:body",this.untrackBody,this);n.on("integrate:positions",this.sweep,this,1);for(i=n.getBodies(),t=0,r=i.length;t<r;++t)this.trackBody({body:i[t]})},disconnect:function(n){n.off("add:body",this.trackBody,this);n.off("remove:body",this.untrackBody,this);n.off("integrate:positions",this.sweep,this,1);this.clear()},broadPhase:function(){return this.updateIntervals(),this.sortIntervalLists(),this._world&&this._world.emit("sweep-prune:intervals",this.intervalLists),this.checkOverlaps()},sortIntervalLists:function(){for(var t,c,u,r,f,h,n,e,o,s=0;s<i;++s)for(t=this.intervalLists[s],u=0,c=t.length,o=s;++u<c;){for(f=t[u],h=f.val.get(o),r=u,n=t[r-1],e=n&&n.val.get(o);r>0&&(e>h||e===h&&n.type&&!f.type);)t[r]=n,r--,n=t[r-1],e=n&&n.val.get(o);t[r]=f}},getPair:function(n,t,i){var u=e(n.id,t.id),r;if(u===!1)return null;if(r=this.pairs[u],!r){if(!i)return null;r=this.pairs[u]={bodyA:n.body,bodyB:t.body,flag:1}}return i&&(r.flag=1),r},checkOverlaps:function(){var y,s,c,l,a,p,h,t,u,w=1<<r.z+1<<r.y+1<<r.x+1,f=this.encounters,o=0,v=this.candidates,e;for(n.util.clearArray(f),n.util.clearArray(v),e=0;e<i;++e)for(y=e===0,a=this.intervalLists[e],h=0,p=a.length;h<p;h++)if(l=a[h],s=l.tracker,l.type)for(t=o,t=o-1;t>=0;t--)c=f[t],c===s?(t<o-1?f[t]=f.pop():f.pop(),o--):(u=this.getPair(s,c,y),u&&u.flag<w&&(u.flag=u.flag<<e+1,u.flag===w&&v.push(u)));else o=f.push(s);return v},updateIntervals:function(){for(var t,i,n,r=this.tracked,u=r.length;--u>=0;)t=r[u],i=t.interval,n=t.body.aabb(),i.min.val.clone(n).sub(n.hw,n.hh),i.max.val.clone(n).add(n.hw,n.hh)},trackBody:function(t){var o=t.body,r={id:f(),body:o},e={min:{type:!1,val:new n.vector,tracker:r},max:{type:!0,val:new n.vector,tracker:r}},u;for(r.interval=e,this.tracked.push(r),u=0;u<i;++u)this.intervalLists[u].push(e.min,e.max)},untrackBody:function(n){for(var e,t,l,a=n.body,r,o,s=this.tracked,u,h,f=0,c=s.length;f<c;++f)if(u=s[f],u.body===a){for(s.splice(f,1),e=0;e<i;++e)for(h=0,r=this.intervalLists[e],t=0,l=r.length;t<l;++t)if(o=r[t],o===u.interval.min||o===u.interval.max){if(r.splice(t,1),t--,c--,h>0)break;h++}break}},sweep:function(){var t=this,n;n=t.broadPhase();n.length&&this._world.emit(this.options.channel,{candidates:n})}}}),n.behavior("verlet-constraints",function(t){var i=2*Math.PI,r={iterations:2};return{init:function(n){t.init.call(this);this.options.defaults(r);this.options(n);this._distanceConstraints=[];this._angleConstraints=[]},connect:function(n){var t=n.integrator();if(t&&t.name.indexOf("verlet")<0)throw'The rigid constraint manager needs a world with a "verlet" compatible integrator.';n.on("integrate:positions",this.resolve,this)},disconnect:function(n){n.off("integrate:positions",this.resolve,this)},drop:function(){return this._distanceConstraints=[],this._angleConstraints=[],this},distanceConstraint:function(t,i,r,u){var f;return!t||!i?!1:(f={id:n.util.uniqueId("dis-constraint"),type:"dis",bodyA:t,bodyB:i,stiffness:r||.5,targetLength:u||i.state.pos.dist(t.state.pos)},f.targetLengthSq=f.targetLength*f.targetLength,this._distanceConstraints.push(f),f)},angleConstraint:function(t,i,r,u,f){var e;return!t||!i?!1:(e={id:n.util.uniqueId("ang-constraint"),type:"ang",bodyA:t,bodyB:i,bodyC:r,stiffness:u||.5,targetAngle:f||i.state.pos.angle2(t.state.pos,r.state.pos)},this._angleConstraints.push(e),e)},remove:function(t){var r,e,f,i,u;if(f=n.util.isObject(t),e=f?t.type:t.substr(0,3),r=e==="ang"?this._angleConstraints:this._distanceConstraints,f){for(i=0,u=r.length;i<u;++i)if(r[i]===t)return r.splice(i,1),this}else for(i=0,u=r.length;i<u;++i)if(r[i].id===t)return r.splice(i,1),this;return this},resolveAngleConstraints:function(t){for(var h=this._angleConstraints,c=n.scratchpad(),u=c.transform(),r,e,f,o,s=0,l=h.length;s<l;++s){if(r=h[s],e=r.bodyB.state.pos.angle2(r.bodyA.state.pos,r.bodyC.state.pos),f=e-r.targetAngle,f)f<=-Math.PI?f+=i:f>=Math.PI&&(f-=i);else continue;u.setTranslation(r.bodyB.state.pos);f*=-t*r.stiffness;r.bodyA.treatment==="dynamic"&&r.bodyB.treatment==="dynamic"&&r.bodyC.treatment==="dynamic"&&(o=1/(r.bodyA.mass+r.bodyB.mass+r.bodyC.mass));r.bodyA.treatment==="dynamic"&&(e=r.bodyB.treatment==="dynamic"&&r.bodyC.treatment==="dynamic"?f*(r.bodyB.mass+r.bodyC.mass)*o:r.bodyB.treatment!=="dynamic"?f*r.bodyC.mass/(r.bodyC.mass+r.bodyA.mass):f*r.bodyB.mass/(r.bodyB.mass+r.bodyA.mass),u.setRotation(e),r.bodyA.state.pos.translateInv(u),r.bodyA.state.pos.rotate(u),r.bodyA.state.pos.translate(u));r.bodyC.treatment==="dynamic"&&(e=r.bodyA.treatment==="dynamic"&&r.bodyB.treatment==="dynamic"?-f*(r.bodyB.mass+r.bodyA.mass)*o:r.bodyB.treatment!=="dynamic"?-f*r.bodyA.mass/(r.bodyC.mass+r.bodyA.mass):-f*r.bodyB.mass/(r.bodyB.mass+r.bodyC.mass),u.setRotation(e),r.bodyC.state.pos.translateInv(u),r.bodyC.state.pos.rotate(u),r.bodyC.state.pos.translate(u));r.bodyB.treatment==="dynamic"&&(e=r.bodyA.treatment==="dynamic"&&r.bodyC.treatment==="dynamic"?f*(r.bodyA.mass+r.bodyC.mass)*o:r.bodyA.treatment!=="dynamic"?f*r.bodyC.mass/(r.bodyC.mass+r.bodyB.mass):f*r.bodyA.mass/(r.bodyA.mass+r.bodyC.mass),u.setRotation(e).setTranslation(r.bodyA.state.pos),r.bodyB.state.pos.translateInv(u),r.bodyB.state.pos.rotate(u),r.bodyB.state.pos.translate(u),u.setTranslation(r.bodyC.state.pos),r.bodyB.state.pos.translateInv(u),r.bodyB.state.pos.rotateInv(u),r.bodyB.state.pos.translate(u));r.bodyA.sleepCheck();r.bodyB.sleepCheck();r.bodyC.sleepCheck()}c.done()},resolveDistanceConstraints:function(t){for(var o=this._distanceConstraints,s=n.scratchpad(),r=s.vector(),i,f,h,u,e=0,c=o.length;e<c;++e)i=o[e],r.clone(i.bodyB.state.pos).vsub(i.bodyA.state.pos),f=r.normSq()||Math.random()*.0001,h=t*i.stiffness*(f-i.targetLengthSq)/f,r.mult(h),u=i.bodyA.treatment!=="dynamic"||i.bodyB.treatment!=="dynamic"?1:i.bodyB.mass/(i.bodyA.mass+i.bodyB.mass),i.bodyA.treatment==="dynamic"&&(i.bodyB.treatment==="dynamic"&&r.mult(u),i.bodyA.state.pos.vadd(r),i.bodyB.treatment==="dynamic"&&r.mult(1/u)),i.bodyB.treatment==="dynamic"&&(i.bodyA.treatment==="dynamic"&&r.mult(1-u),i.bodyB.state.pos.vsub(r)),i.bodyA.sleepCheck(),i.bodyB.sleepCheck();s.done()},shuffleConstraints:function(){this._distanceConstraints=n.util.shuffle(this._distanceConstraints);this._angleConstraints=n.util.shuffle(this._angleConstraints)},resolve:function(){for(var n=this.options.iterations,t=1/n,i=0;i<n;i++)this.resolveDistanceConstraints(t),this.resolveAngleConstraints(t)},getConstraints:function(){return{distanceConstraints:[].concat(this._distanceConstraints),angleConstraints:[].concat(this._angleConstraints)}}}}),n.integrator("improved-euler",function(t){return{init:function(n){t.init.call(this,n)},integrateVelocities:function(n,t){for(var f=1-this.options.drag,r=null,i,u=0,e=n.length;u<e;++u)r=n[u],i=r.state,r.treatment==="static"||r.sleep(t)?(i.vel.zero(),i.acc.zero(),i.angular.vel=0,i.angular.acc=0):(i.old.vel.clone(i.vel),i.old.acc.clone(i.acc),i.vel.vadd(i.acc.mult(t)),f&&i.vel.mult(f),i.acc.zero(),i.old.angular.vel=i.angular.vel,i.angular.vel+=i.angular.acc*t,i.angular.acc=0)},integratePositions:function(t,i){for(var e=.5*i*i,u=null,r,o=n.scratchpad(),s=o.vector(),f=0,h=t.length;f<h;++f)u=t[f],r=u.state,u.treatment==="static"||u.sleep()||(r.old.pos.clone(r.pos),s.clone(r.old.vel),r.pos.vadd(s.mult(i)).vadd(r.old.acc.mult(e)),r.old.acc.zero(),r.old.angular.pos=r.angular.pos,r.angular.pos+=r.old.angular.vel*i+r.old.angular.acc*e,r.old.angular.acc=0);o.done()}}}),n.integrator("velocity-verlet-alt",function(t){return n.body.mixin({started:function(n){return n!==undefined&&(this._started=!0),!!this._started}}),{init:function(n){t.init.call(this,n)},integrateVelocities:function(n,t){for(var o=t*t,f=1-this.options.drag,r=null,i,u=0,e=n.length;u<e;++u)r=n[u],i=r.state,r.treatment!=="static"?(r.started()||(i.old.acc.clone(i.acc),i.old.acc.mult(t),i.old.vel.clone(i.vel).vsub(i.old.acc),i.old.acc.mult(1/t)),f&&i.vel.mult(f),i.vel.vadd(i.old.acc.vadd(i.acc).mult(.5*t)),r.started()||(i.old.angular.acc=i.angular.acc,i.old.angular.vel=i.angular.vel-i.old.angular.acc*t),i.angular.vel+=.5*(i.angular.acc+i.old.angular.acc)*t,i.angular.acc=0,r.started(!0)):(i.vel.zero(),i.acc.zero(),i.angular.vel=0,i.angular.acc=0)},integratePositions:function(n,t){for(var f=t*t,r=null,i,u=0,e=n.length;u<e;++u)r=n[u],i=r.state,r.treatment!=="static"&&(i.old.pos.clone(i.pos),i.old.vel.mult(t),i.old.acc.mult(.5*f),i.pos.vadd(i.old.vel).vadd(i.old.acc),i.old.vel.clone(i.vel),i.old.acc.clone(i.acc),i.acc.zero(),i.old.angular.pos=i.angular.pos,i.angular.pos+=i.angular.vel*t+.5*i.old.angular.acc*f,i.old.angular.vel=i.angular.vel,i.old.angular.acc=i.angular.acc,i.angular.acc=0)}}}),n.integrator("velocity-verlet",function(t){return n.body.mixin({started:function(n){return n!==undefined&&(this._started=!0),!!this._started}}),{init:function(n){t.init.call(this,n)},integrate:function(n,t){var i=this._world;return this.integratePositions(n,t),i&&i.emit("integrate:positions",{bodies:n,dt:t}),this.integrateVelocities(n,t),i&&i.emit("integrate:velocities",{bodies:n,dt:t}),this},integrateVelocities:function(n,t){for(var o=t*t,f=1-this.options.drag,r=null,i,u=0,e=n.length;u<e;++u)r=n[u],i=r.state,r.treatment==="static"||r.sleep()?(i.vel.zero(),i.acc.zero(),i.angular.vel=0,i.angular.acc=0):(f&&i.vel.mult(f),i.old.vel.clone(i.vel),i.vel.vadd(i.old.acc.vadd(i.acc).mult(.5*t)),i.old.acc.clone(i.acc),i.acc.zero(),i.old.angular.vel=i.angular.vel,i.old.angular.acc=i.angular.acc,i.angular.vel+=.5*(i.angular.acc+i.old.angular.acc)*t,i.angular.acc=0,r.started(!0))},integratePositions:function(n,t){for(var u=t*t,r=null,i,f=0,e=n.length;f<e;++f)r=n[f],i=r.state,r.treatment==="static"||r.sleep(t)||(r.started()||(i.old.acc.clone(i.acc),i.old.acc.mult(t),i.old.vel.clone(i.vel).vsub(i.old.acc),i.old.acc.mult(1/t)),i.old.pos.clone(i.pos),i.old.vel.mult(t),i.old.acc.mult(.5*u),i.pos.vadd(i.old.vel).vadd(i.old.acc),i.old.vel.mult(1/t),i.old.acc.mult(2/u),r.started()||(i.old.angular.acc=i.angular.acc,i.old.angular.vel=i.angular.vel-i.old.angular.acc*t),i.old.angular.pos=i.angular.pos,i.angular.pos+=i.angular.vel*t+.5*i.old.angular.acc*u)}}}),n.renderer("canvas",function(t){if(!i)return{};var f=Math.PI*2,u=function(n,t){var r=i.createElement(n||"div");return t&&(r.innerHTML=t),r},r={white:"#fff",violet:"#542437",blue:"#53777A"},e={metaEl:null,styles:{point:r.blue,circle:{strokeStyle:r.blue,lineWidth:1,fillStyle:r.blue,angleIndicator:r.white},rectangle:{strokeStyle:r.violet,lineWidth:1,fillStyle:r.violet,angleIndicator:r.white},"convex-polygon":{strokeStyle:r.violet,lineWidth:1,fillStyle:r.violet,angleIndicator:r.white}},offset:{x:0,y:0}};return{init:function(r){var s=this,f,o;t.init.call(this,r);this.options.defaults(e,!0);this.options.onChange(function(){s.options.offset=new n.vector(s.options.offset)});if(this.options(r,!0),this.hiddenCanvas=i.createElement("canvas"),this.hiddenCanvas.width=this.hiddenCanvas.height=100,!this.hiddenCanvas.getContext)throw"Canvas not supported";this.hiddenCtx=this.hiddenCanvas.getContext("2d");f=this.el;f.nodeName.toUpperCase()!=="CANVAS"&&(f=i.createElement("canvas"),this.el.appendChild(f),typeof this.options.el=="string"&&this.el===i.body&&(f.id=this.options.el),this.el=f);this.container=this.el.parentNode;this.ctx=f.getContext("2d");this.els={};this.options.meta&&(o=this.options.metaEl||u(),o.className="pjs-meta",this.els.fps=u("span"),this.els.ipf=u("span"),o.appendChild(u("span","fps: ")),o.appendChild(this.els.fps),o.appendChild(u("br")),o.appendChild(u("span","ipf: ")),o.appendChild(this.els.ipf),f.parentNode.insertBefore(o,f));this._layers={};this.addLayer("main",this.el);this.options.autoResize?this.resize():this.resize(this.options.width,this.options.height)},layer:function(n){return n in this._layers?this._layers[n]:null},addLayer:function(t,r,u){var o=this,e=[],s=n.util.extend({},this.options.styles),f={id:t,el:r||i.createElement("canvas"),options:n.util.options({width:this.el.width,height:this.el.height,manual:!1,autoResize:!0,follow:null,offset:null,scale:1,zIndex:1})(u)};if(t in this._layers)throw'Layer "'+t+'" already added.';return this.el.parentNode.insertBefore(f.el,this.el),f.el.style.position="absolute",f.el.style.zIndex=f.options.zIndex,f.el.className+=" pjs-layer-"+f.id,f.ctx=f.el.getContext("2d"),f.ctx.scale(1,1),f.el.width=f.options.width,f.el.height=f.options.height,f.bodies=e,f.reset=function(n){return e=n||[],f},f.addToStack=function(t){return n.util.isArray(t)?e.push.apply(e,t):e.push(t),f},f.removeFromStack=function(t){var i,r;if(n.util.isArray(t))for(i=0,r=t.length;i<r;++i)f.removeFromStack(t[i]);else i=n.util.indexOf(e,t),i>-1&&e.splice(i,1);return f},f.render=function(t){var i,c=n.scratchpad(),u=c.vector().set(0,0),r=f.options.scale,y,h,l=e.length,a=o._interpolateTime,v=l||f.id!=="main"?e:o._world._bodies;if(f.options.manual)return c.done(),f;for(f.options.offset&&(f.options.offset==="center"?u.add(f.el.width*.5,f.el.height*.5).mult(1/r):u.vadd(f.options.offset).mult(1/r)),f.options.follow&&(u.vsub(f.options.follow.state.pos),u.sub(f.options.follow.state.vel.get(0)*a,f.options.follow.state.vel.get(1)*a)),t!==!1&&f.ctx.clearRect(0,0,f.el.width,f.el.height),r!==1&&(f.ctx.save(),f.ctx.scale(r,r)),h=0,l=v.length;h<l;++h)i=v[h],i.hidden||(y=i.view||(i.view=o.createView(i.geometry,i.styles||s[i.geometry.name])),o.drawBody(i,i.view,f.ctx,u));return r!==1&&f.ctx.restore(),c.done(),f},this._layers[t]=f,f},removeLayer:function(n){var i=n.id?n.id:n,t=this._layers[i].el;return t!==this.el&&t.parentNode.removeChild(t),delete this._layers[i],this},resize:function(n,i){var r,u;t.resize.call(this,n,i);for(u in this._layers)r=this._layers[u],r.options.autoResize&&(r.el.width=this.width,r.el.height=this.height);return this},setStyle:function(t,i){i=i||this.ctx;n.util.isObject(t)?(t.strokeStyle=t.lineWidth?t.strokeStyle:"rgba(0,0,0,0)",n.util.extend(i,t)):(i.fillStyle=i.strokeStyle=t,i.lineWidth=1)},drawCircle:function(n,t,i,r,u){u=u||this.ctx;u.beginPath();this.setStyle(r,u);u.arc(n,t,i,0,f,!1);u.closePath();u.stroke();u.fill()},drawPolygon:function(n,t,i){var r=n[0],f=r.x,e=r.y,o=n.length,u;for(i=i||this.ctx,i.beginPath(),this.setStyle(t,i),i.moveTo(f,e),u=1;u<o;++u)r=n[u],f=r.x,e=r.y,i.lineTo(f,e);o>2&&i.closePath();i.stroke();i.fill()},drawRect:function(n,t,i,r,u,f){var e=i*.5,o=r*.5;f=f||this.ctx;this.setStyle(u,f);f.beginPath();f.rect(n-e,t-o,i,r);f.closePath();f.stroke();f.fill()},drawLine:function(n,t,i,r){var u=n.x,f=n.y;r=r||this.ctx;r.beginPath();this.setStyle(i,r);r.moveTo(u,f);u=t.x;f=t.y;r.lineTo(u,f);r.stroke();r.fill()},draw:function(n,t,i,r){var f=n.name,s=+(r&&r.x),h=+(r&&r.y),c=n.aabb().hw,e,o,u;if(i=i||this.ctx,t=t||this.options.styles[f]||this.options.styles.circle||{},i.save(),i.translate(s,h),f==="circle")this.drawCircle(0,0,n.radius,t,i);else if(f==="convex-polygon")this.drawPolygon(n.vertices,t,i);else if(f==="rectangle")this.drawRect(0,0,n.width,n.height,t,i);else if(f==="compound")for(e=0,o=n.children.length;e<o;e++)u=n.children[e],i.translate(u.pos.x,u.pos.y),i.rotate(u.angle),this.draw(u.g,t,i),i.rotate(-u.angle),i.translate(-u.pos.x,-u.pos.y);else this.drawCircle(0,0,1,t,i);return f!=="compound"&&t.angleIndicator&&(i.beginPath(),this.setStyle(t.angleIndicator,i),i.moveTo(0,0),i.lineTo(c,0),i.closePath(),i.stroke()),i.restore(),this},createView:function(n,t){var i,u=n.aabb(),e=u.hw+Math.abs(u.x),o=u.hh+Math.abs(u.y),f={x:e+1,y:o+1},s=this.hiddenCtx,r=this.hiddenCanvas;return(t=t||this.options.styles[name]||this.options.styles.circle||{},t.src)?(i=new Image,i.src=t.src,t.width&&(i.width=t.width),t.height&&(i.height=t.height),i):(f.x+=t.lineWidth|0,f.y+=t.lineWidth|0,r.width=2*e+2+(2*t.lineWidth|0),r.height=2*o+2+(2*t.lineWidth|0),this.draw(n,t,s,f),i=new Image(r.width,r.height),i.src=r.toDataURL("image/png"),i)},drawMeta:function(n){this.els.fps.innerHTML=n.fps.toFixed(2);this.els.ipf.innerHTML=n.ipf},drawBody:function(n,t,i,r){var f=n.state.pos,e=n.offset,o=n.state.vel,u=this._interpolateTime||0,s,h,c;r=r||this.options.offset;i=i||this.ctx;s=f._[0]+r.x+o._[0]*u;h=f._[1]+r.y+o._[1]*u;c=n.state.angular.pos+n.state.angular.vel*u;i.save();i.translate(s,h);i.rotate(c);i.translate(e._[0],e._[1]);i.drawImage(t,-t.width/2,-t.height/2,t.width,t.height);i.restore()},render:function(n,t){var i;this._world.emit("beforeRender",{renderer:this,meta:t});this.options.meta&&this.drawMeta(t);this._interpolateTime=t.interpolateTime;for(i in this._layers)this._layers[i].render();return this}}}),n.renderer("dom",function(n){if(!i)return{};var u={},o=i.createElement("div"),c=function(n){return n.replace(/(?:^|\s)\w/g,function(n){return n.toUpperCase()})},s=function(n){var r,t,i,f;if(u[n])return u[n];for(r=["Webkit","Moz","Ms","O"],i=0,f=r.length;i<f;++i)if(t=r[i]+c(n),t in o.style)return u[n]=t;return t in o.style?u[n]=n:!1},f="pjs-",t="px",e=s("transform"),h=s("borderRadius"),r=function(n,t){var r=i.createElement(n||"div");return t&&(r.innerHTML=t),r};return{init:function(i){var f,u;n.init.call(this,i);f=this.el;f.style.position="relative";f.style.overflow="hidden";f.style[e]="translateZ(0)";f.style.width=this.options.width+t;f.style.height=this.options.height+t;this.els={};i.meta&&(u=r(),u.className="pjs-meta",this.els.fps=r("span"),this.els.ipf=r("span"),u.appendChild(r("span","fps: ")),u.appendChild(this.els.fps),u.appendChild(r("br")),u.appendChild(r("span","ipf: ")),u.appendChild(this.els.ipf),f.appendChild(u));this.options.autoResize?this.resize():this.resize(this.options.width,this.options.height)},resize:function(i,r){n.resize.call(this,i,r);this.el.style.width=this.width+t;this.el.style.height=this.height+t},pointProperties:function(n){n.style.width="2px";n.style.height="2px";n.style.marginLeft="-1px";n.style.marginTop="-1px";n.style[h]="50%"},circleProperties:function(n,i){var r=i.aabb();n.style.width=r.hw*2+t;n.style.height=r.hh*2+t;n.style.marginLeft=-r.hw+t;n.style.marginTop=-r.hh+t;n.style[h]="50%"},rectangleProperties:function(n,i){var r=i.aabb();n.style.width=r.hw*2+t;n.style.height=r.hh*2+t;n.style.marginLeft=-r.hw+t;n.style.marginTop=-r.hh+t},createView:function(n){var t=r(),i,s=n.name+"Properties",o,h,u;if(t.className=f+n.name,t.style.position="absolute",t.style.top="0px",t.style.left="0px",n.name==="compound")for(o=0,h=n.children.length;o<h;o++)u=n.children[o],i=r(),i.className=f+n.name+" "+f+"child",i.style.position="absolute",i.style.top="0px",i.style.left="0px",this[u.g.name+"Properties"]&&this[u.g.name+"Properties"](i,u.g),i.style[e]="translate("+u.pos._[0]+"px,"+u.pos._[1]+"px) rotate("+u.angle+"rad)",t.appendChild(i);else this[s]&&this[s](t,n);return this.el.appendChild(t),t},connect:function(n){n.on("add:body",this.attach,this);n.on("remove:body",this.detach,this)},disconnect:function(n){n.off("add:body",this.attach,this);n.off("remove:body",this.detach,this)},detach:function(n){var t=n.nodeType&&n||n.body&&n.body.view,i=t&&t.parentNode;return t&&i&&i.removeChild(t),this},attach:function(n){var t=n.nodeType&&n||n.body&&n.body.view;return t&&this.el.appendChild(t),this},drawMeta:function(n){this.els.fps.innerHTML=n.fps.toFixed(2);this.els.ipf.innerHTML=n.ipf},drawBody:function(n,t){var r=n.state.pos,u=n.state.vel,f=n.offset,o,s,h,i=this._interpolateTime;o=r._[0]+u._[0]*i;s=r._[1]+u._[1]*i;h=n.state.angular.pos+n.state.angular.vel*i;t.style[e]="translate("+o+"px,"+s+"px) rotate("+h+"rad) translate("+f._[0]+"px,"+f._[1]+"px)"}}}),n.renderer("pixi",function(r){if(!i)return{};var o=Math.PI*2,u={white:"0xFFFFFF",violet:"0x542437",blue:"0x53777A"},f={font:"18px monospace",fill:"black",align:"left"},e={metaEl:null,offset:{x:0,y:0},styles:{color:!1,point:u.blue,circle:{strokeStyle:u.blue,lineWidth:1,fillStyle:u.blue,angleIndicator:u.white,fillAlpha:1,strokeAlpha:1,alpha:1},rectangle:{strokeStyle:u.violet,lineWidth:1,fillStyle:u.violet,angleIndicator:u.white,fillAlpha:1,strokeAlpha:1,alpha:1},"convex-polygon":{strokeStyle:u.violet,lineWidth:1,fillStyle:u.violet,angleIndicator:u.white,fillAlpha:1,strokeAlpha:1,alpha:1}}};return{init:function(u){var o=this,f,s;if(typeof PIXI=="undefined")throw"PIXI not present - cannot continue";r.init.call(this,u);this.options.defaults(e,!0);this.options.onChange(function(){o.options.offset=new n.vector(o.options.offset)});this.options(u,!0);s=!this.options.styles.color||this.options.styles.color==="transparent";this.stage=new PIXI.Stage(this.options.styles.color);this.meta={};f=this.el&&this.el.nodeName==="CANVAS"?f:null;this.renderer=new PIXI.autoDetectRenderer(this.options.width,this.options.height,{view:f,transparent:s,resolution:t.devicePixelRatio||1});f||(this.el=this.el||i.body,this.el.appendChild(this.renderer.view));this.options.autoResize?this.resize():this.resize(this.options.width,this.options.height)},resize:function(n,t){r.resize.call(this,n,t);this.renderer.resize(this.width,this.height)},connect:function(n){n.on("add:body",this.attach,this);n.on("remove:body",this.detach,this)},disconnect:function(n){n.off("add:body",this.attach,this);n.off("remove:body",this.detach,this)},detach:function(n){var t=n instanceof PIXI.Graphics&&n||n.body&&n.body.view;return t&&this.stage.removeChild(t),this},attach:function(n){var t=n instanceof PIXI.Graphics&&n||n.body&&n.body.view;return t&&this.stage.addChild(t),this},loadSpriteSheets:function(t,i){if(!n.util.isArray(t))throw"Spritesheets must be defined in arrays";var r=this,u=new PIXI.AssetLoader(t);u.load();u.on("onComplete",function(){r.assetsLoaded=!0;i()});return r},drawBody:function(n,t){var r=n.state.pos,u=n.state.vel,f=n.offset,i=this._interpolateTime||0,e,o,s;e=r._[0]+u._[0]*i;o=r._[1]+u._[1]*i;s=n.state.angular.pos+n.state.angular.vel*i;t.position.set(e,o);t.pivot.set(-f._[0],-f._[1]);t.rotation=s},render:function(n,t){r.render.call(this,n,t);this.renderer.render(this.stage)},setStyles:function(t,i){return n.util.isObject(i)?(i.fillStyle&&i.fillStyle!=="transparent"?(t.beginFill(i.fillStyle),t.fillAlpha=i.fillAlpha!==undefined?i.fillAlpha:1):(t.beginFill(),t.fillAlpha=0),t.lineStyle(i.lineWidth||0,i.strokeStyle,i.strokeAlpha!==undefined?i.strokeAlpha:1),t.alpha=i.alpha!==undefined?i.alpha:1):(i&&i!=="transparent"?t.beginFill(i):(t.beginFill(),t.fillAlpha=0),t.lineStyle(0)),t},createCircle:function(n,t,i,r){var u=new PIXI.Graphics;return this.setStyles(u,r),u.drawCircle(n,t,i),u.endFill(),u},createRect:function(n,t,i,r,u){var f=new PIXI.Graphics;return this.setStyles(f,u),f.drawRect(n,t,i,r),f.endFill(),f},createPolygon:function(n,t){var r=n[0],u=r.x,f=r.y,o=n.length,s={x:u,y:f},i=new PIXI.Graphics,e;for(this.setStyles(i,t),i.moveTo(u,f),e=1;e<o;++e)r=n[e],u=r.x,f=r.y,i.lineTo(u,f);return o>2&&i.lineTo(s.x,s.y),i.endFill(),i},createLine:function(n,t,i){var u=n.x,f=n.y,r=new PIXI.Graphics;return this.setStyles(r,i),r.moveTo(u,f),u=t.x,f=t.y,r.lineTo(u,f),r.endFill(),r},createView:function(n,t,i){var r=null,e=n.aabb(),c=e.hw+Math.abs(e.x),l=e.hh+Math.abs(e.y),u=n.name,o,h,f,s;if(i=i||this.stage,t=t||this.options.styles[u]||this.options.styles.circle||{},t.src)return r=PIXI.Sprite.fromImage(t.src),r.anchor.set(.5,.5),t.anchor&&(r.anchor.x=t.anchor.x,r.anchor.y=t.anchor.y),t.width&&(r.width=t.width),t.height&&(r.height=t.height),i.addChild(r),r;if(u==="circle")r=this.createCircle(0,0,n.radius,t);else if(u==="convex-polygon")r=this.createPolygon(n.vertices,t);else if(u==="rectangle")r=this.createRect(-n.width/2,-n.height/2,n.width,n.height,t);else if(u==="compound")for(r=new PIXI.Graphics,o=0,h=n.children.length;o<h;o++)f=n.children[o],s=this.createView(f.g,t,r),s.position.set(f.pos.x,f.pos.y),s.rotation=f.angle;else r=this.createCircle(0,0,1,t);return u!=="compound"&&t.angleIndicator&&t.angleIndicator!=="transparent"&&(r.lineStyle(t.lineWidth,t.angleIndicator),r.moveTo(0,0),r.lineTo(c,0)),u!=="compound"&&(r.cacheAsBitmap=!0),i.addChild(r),r},drawMeta:function(n){this.meta.loaded?(this.meta.fps.setText("FPS: "+n.fps.toFixed(2)),this.meta.ipf.setText("IPF: "+n.ipf)):(this.meta.fps=new PIXI.Text("FPS: "+n.fps.toFixed(2),f),this.meta.fps.position.x=15,this.meta.fps.position.y=5,this.meta.ipf=new PIXI.Text("IPF: "+n.ipf,f),this.meta.ipf.position.x=15,this.meta.ipf.position.y=30,this.stage.addChild(this.meta.fps),this.stage.addChild(this.meta.ipf),this.meta.loaded=!0)},createDisplay:function(n,t){var i=null,u=null,f,r;switch(n){case"sprite":return u=PIXI.Texture.fromImage(t.texture),i=new PIXI.Sprite(u),t.anchor&&(i.anchor.x=t.anchor.x,i.anchor.y=t.anchor.y),t.container?t.container.addChild(i):this.stage.addChild(i),i;case"movieclip":if(!this.assetsLoaded)throw"No assets have been loaded. Use loadSpritesheet() first";for(f=[],r=0,r;r<t.frames.length;r++)u=PIXI.Texture.fromFrame(t.frames[r]),f.push(u);return i=new PIXI.MovieClip(f),t.anchor&&(i.anchor.x=t.anchor.x,i.anchor.y=t.anchor.y),t.container?t.container.addChild(i):this.stage.addChild(i),i;default:throw"Invalid PIXI.DisplayObject passed";}},centerAnchor:function(n){n!==null&&(n.anchor.x=.5,n.anchor.y=.5)}}}),n});