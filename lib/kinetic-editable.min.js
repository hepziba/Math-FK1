function init(n){var t=window.Kinetic||n;if(t==="undefined")throw new Error("Kinetic must be a global variable or passed to init.");t.EditableText=function(n){var f,r,u,i;for(n.name="EditableText",n.fontSize=n.fontSize||16,n.lineHeight=n.lineHeight||1.3,this.focusRectColor=n.focusRectColor||"black",delete n.focusRectColor,n.unfocusOnEnter=n.unfocusOnEnter||!1,n.pasteModal=n.pasteModal||null,f=n.fontSize,this.lineHeightPx=n.lineHeight*f,this.initialRectW=100<n.fontSize*3?n.fontSize*4:100,this.initialRectH=f+10,this.defaultText=n.defaultText,delete n.defaultText,this.defaultText&&!n.text?n.text=this.defaultText:n.text||(n.text=""),r=n.text.split("\n"),u=0,this.totalLines=r.length||1,this.currentLine=r.length-1||0,this.tempText=[],this.configTemp=Object.create(n),this.configTemp.draggable=!1,i=0;i<this.totalLines;i++)this.tempText[i]=new t.Text(this.configTemp),this.tempText[i].setText(r[i]),this.tempText[i].width()>u&&(u=this.tempText[i].width());this.focusRectW=u+20;this.focusRectH=this.initialRectH;this.maxWidth=0;this.currentWordLetters=this.tempText[this.tempText.length-1].getText().split(" ").length;this.currentWordCursorPos=this.tempText[this.tempText.length-1].getText().replace(/\n/g,"").length;this.noStageError=new Error("The Kinetic.EditableText shape must be added to a stage!");this.drawHitFunc=function(n){var t=n.getContext();t.beginPath();t.rect(0,0,this.focusRectW,this.focusRectH);t.closePath();n.fillStroke(this)};this.config=n;t.Text.call(this,n);this.classType="EditableText";this.className="EditableText";this.ctrlDown=!1;this.shiftDown=!1};t.EditableText.prototype={focus:function(){var n=this,i=this.getLayer(),r=this.getStage();if(!i)throw this.noLayerError;if(!r)throw this.noStageError;this.initKeyHandlers();this.hide();this.focusRect=new t.Rect({x:this.x()-5,y:this.y()-5,width:this.focusRectW,height:this.totalLines*this.lineHeightPx+5,stroke:this.focusRectColor,strokeWidth:1,listening:!1});this.defaultText===this.tempText[0].getText().trim()&&(this.setText(""),this.tempText[0].setText(""),this.currentWordCursorPos=0,this.currentWordLetters=0);this.cursorLine=new t.Line({points:[0,this.y(),0,this.y()+this.focusRectH-10],stroke:"black"});this.cursorInterval=setInterval(function(){n.cursorLine.isVisible()?n.cursorLine.hide():n.cursorLine.show();i.draw()},500);$.each(this.tempText,function(t,r){r.position({x:n.x(),y:n.y()+t*n.lineHeightPx});i.add(r)});i.add(this.focusRect);i.add(this.cursorLine);n.detectCursorPosition();i.draw()},findCursorPosFromClick:function(){var n=this,r=this.getStage(),i=this.getLayer(),t;if(!i)throw this.noLayerError;if(!r)throw this.noStageError;t=r.getPointerPosition();$.each(this.tempText,function(i,r){if(t.y<r.y()+n.lineHeightPx&&t.y>r.y()){var s,o,e=0,u=r.clone(),f=u.width(),h=!0;for(n.currentLine=i;f>0&&e<4e3;)f=u.width(),o=u.text(),u.text(o.substring(0,o.length-1)),e++;for(n.currentWordLetters=e===0?0:e-1,e=0,u=n.tempText[n.currentLine].clone(),f=u.width();f>0;){if(s=f,f=u.width(),t.x>n.tempText[n.currentLine].x()+f){t.x-(n.tempText[n.currentLine].x()+f)>(s-f)/2&&(h=!1);n.currentWordCursorPos=n.currentWordLetters-e;break}o=u.text();u.text(o.substring(0,o.length-1));e++}!h&&n.currentWordCursorPos<n.currentWordLetters&&n.currentWordCursorPos++;n.detectCursorPosition()}});i.draw();n.cursorLine.show();i.draw();clearInterval(n.cursorInterval);n.cursorInterval=setInterval(function(){n.cursorLine.isVisible()?n.cursorLine.hide():n.cursorLine.show();i.draw()},500)},detectCursorPosition:function(){var n=this.tempText[this.currentLine].clone(),i=this.tempText[this.currentLine].y(),r=n.text(),u=this.focusRectH-10,t;n.text(r.substring(0,this.currentWordCursorPos));t=this.tempText[this.currentLine].getX()+n.getWidth();this.cursorLine.points([t+5,i,t+5,i+u])},checkClick:function(){var t=this.getStage(),n;if(!t)throw this.noStageError;return n=t.getPointerPosition(),n.x>this.getX()&&n.x<this.getX()+this.focusRect.getWidth()&&n.y>this.getY()&&n.y<this.getY()+this.focusRect.getHeight()},unfocus:function(){var n="",t=$("body"),r=this.getLayer(),i;if(!r)throw this.noLayerError;clearInterval(this.cursorInterval);$.each(this.tempText,function(t,i){n+=i.getText()+"\n"});n&&n.trim()!==""?this.setText(n):(i=this.defaultText||"",this.setText(i),this.tempText[0].setText(i),this.focusRectW=this.initialRectW,this.focusRectH=this.initialRectH);this.focusRect.destroy();this.cursorLine.destroy();$.each(this.tempText,function(n,t){t.destroy()});this.show();r.draw();t.off("keydown");t.off("keypress");t.off("keyup")},initKeyHandlers:function(){var n=this,t=$("body");t.on("keydown",function(t){var r=t.charCode||t.keyCode,u=n.getLayer(),s,h,c;if(t.which===8&&t.preventDefault(),r==27){n.unfocus(t);return}if(!u)throw n.noLayerError;n.cursorLine.show();u.draw();clearInterval(n.cursorInterval);n.cursorInterval=setInterval(function(){n.cursorLine.isVisible()?n.cursorLine.hide():n.cursorLine.show();u.draw()},500);switch(r){case 16:n.shiftDown||(n.shiftDown=!0);break;case 17:n.ctrlDown||(n.ctrlDown=!0);break;case 86:n.ctrlDown&&(s=$("#"+n.config.pasteModal),s.val(""),s.focus(),setTimeout(function(){for(var o=$("#"+n.config.pasteModal).val(),i=o.split(/\r\n|\r|\n/g),s=i[i.length-1].length,r=n.currentWordCursorPos,h=n.currentLine,f=n.tempText[n.currentLine].text(),c=f.substring(0,r),l=f.substring(r,f.length),e="",t=0;t<n.tempText.length;t++)e+=t===n.currentLine?c+o+l:n.tempText[t].text(),n.tempText[t+1]!=="undefined"&&(e+="\n");n.text(e);n.currentWordCursorPos=n.currentLine!==h?s:r+s;n.currentLine=h+i.length-1;n.detectCursorPosition();u.draw()},0));break;case 37:n.currentWordCursorPos!==0?n.currentWordCursorPos--:n.currentLine!==0&&(n.currentLine--,h=n.tempText[n.currentLine].text().length,n.currentWordCursorPos=h,n.currentWordLetters=h);n.detectCursorPosition();u.draw();break;case 39:n.currentWordCursorPos!==n.currentWordLetters?n.currentWordCursorPos++:n.currentLine!==n.totalLines-1&&(n.currentLine++,c=n.tempText[n.currentLine].text().length,n.currentWordCursorPos=0,n.currentWordLetters=c);n.detectCursorPosition();u.draw();break;case 38:case 40:if(r===38&&n.currentLine===0||r===40&&n.currentLine===n.totalLines-1)return!1;r===38?n.currentLine--:n.currentLine++;for(var l={x:n.cursorLine.points()[0].x,y:n.tempText[n.currentLine].y()},a,o,e=0,f=n.tempText[n.currentLine].clone(),i=f.width(),v=!0;i>0&&e<4e3;)i=f.width(),o=f.text(),f.text(o.substring(0,o.length-1)),e++;for(n.currentWordLetters=e===0?0:e-1,e=0,i=f.width();i>0;){if(a=i,i=f.width(),l.x>n.tempText[n.currentLine].x()+i){l.x-(n.tempText[n.currentLine].x()+i)>(a-i)/2&&(v=!1);n.currentWordCursorPos=n.currentWordLetters-e;break}o=f.text();f.text(o.substring(0,o.length-1));e++}!v&&n.currentWordCursorPos<n.currentWordLetters&&n.currentWordCursorPos++;n.currentWordCursorPos>n.currentWordLetters&&(n.currentWordCursorPos=n.currentWordLetters);n.detectCursorPosition();u.draw();break;case 35:case 36:r===36&&(n.currentWordCursorPos=0);r===35&&(n.currentWordCursorPos=n.currentWordLetters);n.detectCursorPosition();u.draw();break;case 8:case 46:n.removeChar(r);break;case 13:n.unfocusOnEnter?n.unfocus(t):n.ctrlDown?(n.unfocus(t),n.ctrlDown=!1):n.newLine()}});t.on("keyup",function(t){var i=t.charCode||t.keyCode;switch(i){case 16:n.shiftDown=!1;break;case 17:n.ctrlDown=!1}});t.on("keypress",function(t){return n.addChar(t),!1})},toObject:function(){var u=t.Util,f={},r=this.getAttrs(),n,i,e,o;f.attrs={};for(n in r)r.hasOwnProperty(n)&&(i=r[n],u._isFunction(i)||u._isElement(i)||u._isObject(i)&&u._hasMethods(i)||(e=this[n],delete r[n],o=e?e.call(this):null,r[n]=i,f.attrs[n]=n==="text"?o.replace(/\n$/g,""):i?i:o));return f.className=this.getClassName(),f},newLine:function(n){var i=this,f=this.getLayer(),r,u;if(!f)throw this.noLayerError;if(i.focusRect.height(i.focusRect.height()+i.lineHeightPx),i.currentLine++,i.totalLines++,r=i.totalLines-1,i.tempText[r]=new t.Text(i.configTemp),f.add(i.tempText[r]),i.tempText[r].x(i.x()),i.tempText[r].y(i.y()+r*i.lineHeightPx),i.currentLine<i.totalLines-1)for(u=i.totalLines;u>i.currentLine+1;u--)i.tempText[u-1].text(i.tempText[u-2].text());var e=i.tempText[i.currentLine-1].text(),s=e.substring(0,i.currentWordCursorPos),o=e.substring(i.currentWordCursorPos,e.length);i.tempText[i.currentLine-1].text(s);i.tempText[i.currentLine].text(o);i.currentWordCursorPos=0;i.currentWordLetters=o.length;i.detectCursorPosition();f.draw();n!==!0&&i.fire("change")},addChar:function(n,t){var i=this,f=this.getLayer(),r;if(!f)throw this.noLayerError;if(r=n.charCode||n.keyCode,r!==8&&r!==13){var e=typeof n=="string"?n:String.fromCharCode(r),u=i.tempText[i.currentLine].text(),o=u.substring(0,i.currentWordCursorPos),s=u.substring(i.currentWordCursorPos,u.length),h=o+e+s;i.tempText[i.currentLine].text(h);i.currentWordCursorPos++;i.currentWordLetters++;typeof n!="string"&&i.detectCursorPosition();$.each(i.tempText,function(n,t){t.width()>i.maxWidth&&(i.maxWidth=t.width())});i.maxWidth<i.tempText[i.currentLine].width()&&(i.maxWidth=i.tempText[i.currentLine].width());i.tempText[i.currentLine].width()>=i.maxWidth&&i.focusRect.width(80<i.tempText[i.currentLine].width()?i.tempText[i.currentLine].width()+20:100);i.focusRectW=i.focusRect.width();f.draw();t!==!0&&i.fire("change")}},removeChar:function(n,t){var i=this,f=this.getLayer(),o,h,c;if(n!==8&&n!==46)throw new Error("The first argument passed to Kinetic.EditableText.removeChar() must be the integer 8 (backspace key code) or 46 (delete key code)");if(!f)throw this.noLayerError;var r,e=i.tempText[i.currentLine].width(),s=i.tempText[i.currentLine].text(),u=i.tempText[i.currentLine].text(),l=u.substring(0,n===8?i.currentWordCursorPos-1:i.currentWordCursorPos),a=u.substring(n===8?i.currentWordCursorPos:i.currentWordCursorPos+1,u.length);if(n===8&&i.currentWordCursorPos===0&&i.currentLine>0){for(o=i.tempText[i.currentLine-1].text().length,h=i.tempText[i.currentLine-1]?i.tempText[i.currentLine-1].text():"",i.tempText[i.currentLine-1].text(h+s),i.currentWordLetters+=o,i.currentWordCursorPos=o,i.currentLine--,r=i.currentLine+1;r<i.totalLines-1;r++)i.tempText[r].text(i.tempText[r+1].text());console.log(i.tempText[r].text());i.tempText[r].text("");i.tempText[r].destroy();i.tempText.splice(r);i.focusRect.height(i.focusRect.height()-i.lineHeightPx);i.totalLines--;e>=i.maxWidth&&(i.focusRect.width(80<i.tempText[i.currentLine].width()?i.tempText[i.currentLine].width()+20:100),i.maxWidth=i.tempText[i.currentLine].width());i.detectCursorPosition();f.draw();return}if(n===46&&i.currentWordCursorPos===i.currentWordLetters&&i.currentLine<i.totalLines-1){for(c=i.tempText[i.currentLine+1]?i.tempText[i.currentLine+1].text():"",i.tempText[i.currentLine].text(s+c),i.currentWordLetters+=i.tempText[i.currentLine+1].text().length,r=i.currentLine+1;r<i.totalLines-1;r++)i.tempText[r].text(i.tempText[r+1].text());i.tempText[r].text("");i.focusRect.height(i.focusRect.height()-i.lineHeightPx);i.totalLines--;e>=i.maxWidth&&(i.focusRect.width(80<i.tempText[i.currentLine].width()?i.tempText[i.currentLine].width()+20:100),i.maxWidth=i.tempText[i.currentLine].width());f.draw();return}u=l+a;n===8&&i.currentWordCursorPos>0&&i.currentWordCursorPos--;i.currentWordLetters--;i.tempText[i.currentLine].text(u);i.detectCursorPosition();$.each(i.tempText,function(n,t){t.width()>i.maxWidth&&(i.maxWidth=t.width())});e>=i.maxWidth&&(i.focusRect.width(80<i.tempText[i.currentLine].width()?i.tempText[i.currentLine].width()+20:100),i.maxWidth=i.tempText[i.currentLine].width());i.focusRectW=i.focusRect.width();f.draw();t!==!0&&i.fire("change")},backspaceChar:function(){this.removeChar(8)},deleteChar:function(){this.removeChar(46)},clear:function(n){var i=this.getLayer(),t;if(!i)throw this.noLayerError;for(t=this.totalLines-1;t>-1;t--)t===0?this.tempText[t].text(""):(this.tempText[t].destroy(),this.tempText.length=t);this.focusRectW=this.initialRectW;this.focusRectH=this.initialRectH;this.focusRect.width=this.focusRectW;this.focusRect.height=this.focusRectH;this.currentLine=0;this.totalLines=1;this.maxWidth=0;this.currentWordLetters=0;this.currentWordCursorPos=0;this.detectCursorPosition();i.draw();n!==!0&&this.fire("change")},text:function(n,t){var i,r;if(arguments.length===0){for(r="",i=0;i<this.tempText.length;i++)r+=this.tempText[i].text(),this.tempText[i+1]!=="undefined"&&(r+="\n");return r}if(typeof n=="string"){for(this.clear(!0),i=0;i<n.length;i++)/\r\n|\r|\n/g.exec(n[i])?this.newLine(!0):this.addChar(n[i],!0);this.detectCursorPosition()}else throw new Error("The first argument passed to Kinetic.EditableText.text() must be a string");t!==!0&&this.fire("change")}};t.Util.extend(t.EditableText,t.Text)}var define=window.define||{},module=window.module||{},defineType=typeof define,defineAmdType=typeof define.amd;defineType==="function"&&defineAmdType==="object"?define({init:init}):module!=="undefined"&&module.exports?module.kineticEditableText={init:init}:init();